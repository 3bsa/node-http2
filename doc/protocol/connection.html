<!DOCTYPE html>

<html>
<head>
  <title>The Connection class</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              <a class="source" href="../index.html">API</a>
              
                
                <a class="source" href="compressor.html">
                  compressor.js
                </a>
              
                
                <a class="source" href="connection.html">
                  connection.js
                </a>
              
                
                <a class="source" href="endpoint.html">
                  endpoint.js
                </a>
              
                
                <a class="source" href="flow.html">
                  flow.js
                </a>
              
                
                <a class="source" href="framer.html">
                  framer.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="stream.html">
                  stream.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="the-connection-class">The Connection class</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The Connection class manages HTTP/2 connections. Each instance corresponds to one transport
stream (TCP stream). It operates by sending and receiving frames and is implemented as a
<a href="flow.html">Flow</a> subclass.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> Flow = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./flow'</span>).Flow;

exports.Connection = Connection;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="public-api">Public API</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <ul>
<li><p><strong>new Connection(log, firstStreamId, settings)</strong>: create a new Connection</p>
</li>
<li><p><strong>Event: ‘error’ (type)</strong>: signals a connection level error made by the other end</p>
</li>
<li><p><strong>Event: ‘peerError’ (type)</strong>: signals the receipt of a GOAWAY frame that contains an error
code other than NO_ERROR</p>
</li>
<li><p><strong>Event: ‘stream’ (stream)</strong>: signals that there’s an incoming stream</p>
</li>
<li><p><strong>createStream(): stream</strong>: initiate a new stream</p>
</li>
<li><p><strong>set(settings, callback)</strong>: change the value of one or more settings according to the
key-value pairs of <code>settings</code>. The callback is called after the peer acknowledged the changes.</p>
</li>
<li><p><strong>ping([callback])</strong>: send a ping and call callback when the answer arrives</p>
</li>
<li><p><strong>close([error])</strong>: close the stream with an error code</p>
</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2 id="constructor">Constructor</h2>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The main aspects of managing the connection are:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Connection</span>(<span class="hljs-params">log, firstStreamId, settings</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <ul>
<li>initializing the base class</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Flow.call(<span class="hljs-keyword">this</span>, <span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <ul>
<li>logging: every method uses the common logger object</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._log = log.child({ component: <span class="hljs-string">'connection'</span> });</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <ul>
<li>stream management</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._initializeStreamManagement(firstStreamId);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <ul>
<li>lifecycle management</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._initializeLifecycleManagement();</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <ul>
<li>flow control</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._initializeFlowControl();</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <ul>
<li>settings management</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._initializeSettingsManagement(settings);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <ul>
<li>multiplexing</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._initializeMultiplexing();
}
Connection.prototype = <span class="hljs-built_in">Object</span>.create(Flow.prototype, { constructor: { value: Connection } });</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h2 id="overview">Overview</h2>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <pre><code>         |    ^             |    ^
         v    |             v    |
    +--------------+   +--------------+
+---|   stream1    |---|   stream2    |----      ....      ---+
|   | +----------+ |   | +----------+ |                       |
|   | | stream1. | |   | | stream2. | |                       |
|   +-| upstream |-+   +-| upstream |-+                       |
|     +----------+       +----------+                         |
|       |     ^             |     ^                           |
|       v     |             v     |                           |
|       +-----+-------------+-----+--------      ....         |
|       ^     |             |     |                           |
|       |     v             |     |                           |
|   +--------------+        |     |                           |
|   |   stream0    |        |     |                           |
|   |  connection  |        |     |                           |
|   |  management  |     multiplexing                         |
|   +--------------+     flow control                         |
|                           |     ^                           |
|                   _read() |     | _write()                  |
|                           v     |                           |
|                +------------+ +-----------+                 |
|                |output queue| |input queue|                 |
+----------------+------------+-+-----------+-----------------+
                            |     ^
                     read() |     | write()
                            v     |
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2 id="stream-management">Stream management</h2>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> Stream  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./stream'</span>).Stream;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Initialization:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._initializeStreamManagement = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initializeStreamManagement</span>(<span class="hljs-params">firstStreamId</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <ul>
<li>streams are stored in two data structures:<ul>
<li><code>_streamIds</code> is an id -&gt; stream map of the streams that are allowed to receive frames.</li>
<li><code>_streamPriorities</code> is a priority -&gt; [stream] map of stream that allowed to send frames.</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._streamIds = [];
  <span class="hljs-keyword">this</span>._streamPriorities = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <ul>
<li>The next outbound stream ID and the last inbound stream id</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._nextStreamId = firstStreamId;
  <span class="hljs-keyword">this</span>._lastIncomingStream = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <ul>
<li>Calling <code>_writeControlFrame</code> when there’s an incoming stream with 0 as stream ID</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._streamIds[<span class="hljs-number">0</span>] = { upstream: { write: <span class="hljs-keyword">this</span>._writeControlFrame.bind(<span class="hljs-keyword">this</span>) } };</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <ul>
<li>By default, the number of concurrent outbound streams is not limited. The <code>_streamLimit</code> can
be set by the SETTINGS_MAX_CONCURRENT_STREAMS setting.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._streamSlotsFree = <span class="hljs-literal">Infinity</span>;
  <span class="hljs-keyword">this</span>._streamLimit = <span class="hljs-literal">Infinity</span>;
  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'RECEIVING_SETTINGS_MAX_CONCURRENT_STREAMS'</span>, <span class="hljs-keyword">this</span>._updateStreamLimit);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><code>_writeControlFrame</code> is called when there’s an incoming frame in the <code>_control</code> stream. It
broadcasts the message by creating an event on it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._writeControlFrame = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_writeControlFrame</span>(<span class="hljs-params">frame</span>) </span>{
  <span class="hljs-keyword">if</span> ((frame.type === <span class="hljs-string">'SETTINGS'</span>) || (frame.type === <span class="hljs-string">'PING'</span>) ||
      (frame.type === <span class="hljs-string">'GOAWAY'</span>) || (frame.type === <span class="hljs-string">'WINDOW_UPDATE'</span>) ||
      (frame.type === <span class="hljs-string">'ALTSVC'</span>)) {
    <span class="hljs-keyword">this</span>._log.debug({ frame: frame }, <span class="hljs-string">'Receiving connection level frame'</span>);
    <span class="hljs-keyword">this</span>.emit(frame.type, frame);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>._log.error({ frame: frame }, <span class="hljs-string">'Invalid connection level frame'</span>);
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-string">'PROTOCOL_ERROR'</span>);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Methods to manage the stream slot pool:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._updateStreamLimit = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_updateStreamLimit</span>(<span class="hljs-params">newStreamLimit</span>) </span>{
  <span class="hljs-keyword">var</span> wakeup = (<span class="hljs-keyword">this</span>._streamSlotsFree === <span class="hljs-number">0</span>) &amp;&amp; (newStreamLimit &gt; <span class="hljs-keyword">this</span>._streamLimit);
  <span class="hljs-keyword">this</span>._streamSlotsFree += newStreamLimit - <span class="hljs-keyword">this</span>._streamLimit;
  <span class="hljs-keyword">this</span>._streamLimit = newStreamLimit;
  <span class="hljs-keyword">if</span> (wakeup) {
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'wakeup'</span>);
  }
};

Connection.prototype._changeStreamCount = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_changeStreamCount</span>(<span class="hljs-params">change</span>) </span>{
  <span class="hljs-keyword">if</span> (change) {
    <span class="hljs-keyword">this</span>._log.trace({ free: <span class="hljs-keyword">this</span>._streamSlotsFree, change: change },
                    <span class="hljs-string">'Changing active stream count.'</span>);
    <span class="hljs-keyword">var</span> wakeup = (<span class="hljs-keyword">this</span>._streamSlotsFree === <span class="hljs-number">0</span>) &amp;&amp; (change &lt; <span class="hljs-number">0</span>);
    <span class="hljs-keyword">this</span>._streamSlotsFree -= change;
    <span class="hljs-keyword">if</span> (wakeup) {
      <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'wakeup'</span>);
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Creating a new <em>inbound or outbound</em> stream with the given <code>id</code> (which is undefined in case of
an outbound stream) consists of three steps:</p>
<ol>
<li>var stream = new Stream(this._log, this);</li>
<li>this._allocateId(stream, id);</li>
<li>this._allocatePriority(stream);</li>
</ol>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Allocating an ID to a stream</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._allocateId = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_allocateId</span>(<span class="hljs-params">stream, id</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <ul>
<li>initiated stream without definite ID</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (id === <span class="hljs-literal">undefined</span>) {
    id = <span class="hljs-keyword">this</span>._nextStreamId;
    <span class="hljs-keyword">this</span>._nextStreamId += <span class="hljs-number">2</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <ul>
<li>incoming stream with a legitim ID (larger than any previous and different parity than ours)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((id &gt; <span class="hljs-keyword">this</span>._lastIncomingStream) &amp;&amp; ((id - <span class="hljs-keyword">this</span>._nextStreamId) % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>)) {
    <span class="hljs-keyword">this</span>._lastIncomingStream = id;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <ul>
<li>incoming stream with invalid ID</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>._log.error({ stream_id: id, lastIncomingStream: <span class="hljs-keyword">this</span>._lastIncomingStream },
                    <span class="hljs-string">'Invalid incoming stream ID.'</span>);
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-string">'PROTOCOL_ERROR'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  }

  assert(!(id <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>._streamIds));</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <ul>
<li>adding to <code>this._streamIds</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._log.trace({ s: stream, stream_id: id }, <span class="hljs-string">'Allocating ID for stream.'</span>);
  <span class="hljs-keyword">this</span>._streamIds[id] = stream;
  stream.id = id;
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'new_stream'</span>, stream, id);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <ul>
<li>forwarding connection errors from streams</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  stream.on(<span class="hljs-string">'connectionError'</span>, <span class="hljs-keyword">this</span>.emit.bind(<span class="hljs-keyword">this</span>, <span class="hljs-string">'error'</span>));

  <span class="hljs-keyword">return</span> id;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Allocating a priority to a stream, and managing priority changes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._allocatePriority = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_allocatePriority</span>(<span class="hljs-params">stream</span>) </span>{
  <span class="hljs-keyword">this</span>._log.trace({ s: stream }, <span class="hljs-string">'Allocating priority for stream.'</span>);
  <span class="hljs-keyword">this</span>._insert(stream, stream._priority);
  stream.on(<span class="hljs-string">'priority'</span>, <span class="hljs-keyword">this</span>._reprioritize.bind(<span class="hljs-keyword">this</span>, stream));
  stream.upstream.on(<span class="hljs-string">'readable'</span>, <span class="hljs-keyword">this</span>.emit.bind(<span class="hljs-keyword">this</span>, <span class="hljs-string">'wakeup'</span>));
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'wakeup'</span>);
};

Connection.prototype._insert = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_insert</span>(<span class="hljs-params">stream, priority</span>) </span>{
  <span class="hljs-keyword">if</span> (priority <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>._streamPriorities) {
    <span class="hljs-keyword">this</span>._streamPriorities[priority].push(stream);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>._streamPriorities[priority] = [stream];
  }
};

Connection.prototype._reprioritize = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_reprioritize</span>(<span class="hljs-params">stream, priority</span>) </span>{
  <span class="hljs-keyword">var</span> bucket = <span class="hljs-keyword">this</span>._streamPriorities[stream._priority];
  <span class="hljs-keyword">var</span> index = bucket.indexOf(stream);
  assert(index !== -<span class="hljs-number">1</span>);
  bucket.splice(index, <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (bucket.length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._streamPriorities[stream._priority];
  }

  <span class="hljs-keyword">this</span>._insert(stream, priority);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Creating an <em>inbound</em> stream with the given ID. It is called when there’s an incoming frame to
a previously nonexistent stream.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._createIncomingStream = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_createIncomingStream</span>(<span class="hljs-params">id</span>) </span>{
  <span class="hljs-keyword">this</span>._log.debug({ stream_id: id }, <span class="hljs-string">'New incoming stream.'</span>);

  <span class="hljs-keyword">var</span> stream = <span class="hljs-keyword">new</span> Stream(<span class="hljs-keyword">this</span>._log, <span class="hljs-keyword">this</span>);
  <span class="hljs-keyword">this</span>._allocateId(stream, id);
  <span class="hljs-keyword">this</span>._allocatePriority(stream);
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'stream'</span>, stream, id);

  <span class="hljs-keyword">return</span> stream;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Creating an <em>outbound</em> stream</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype.createStream = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createStream</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>._log.trace(<span class="hljs-string">'Creating new outbound stream.'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <ul>
<li>Receiving is enabled immediately, and an ID gets assigned to the stream</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> stream = <span class="hljs-keyword">new</span> Stream(<span class="hljs-keyword">this</span>._log, <span class="hljs-keyword">this</span>);
  <span class="hljs-keyword">this</span>._allocatePriority(stream);

  <span class="hljs-keyword">return</span> stream;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h2 id="multiplexing">Multiplexing</h2>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
Connection.prototype._initializeMultiplexing = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initializeMultiplexing</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'window_update'</span>, <span class="hljs-keyword">this</span>.emit.bind(<span class="hljs-keyword">this</span>, <span class="hljs-string">'wakeup'</span>));
  <span class="hljs-keyword">this</span>._sendScheduled = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">this</span>._firstFrameReceived = <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>The <code>_send</code> method is a virtual method of the <a href="flow.html">Flow class</a> that has to be implemented
by child classes. It reads frames from streams and pushes them to the output buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._send = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_send</span>(<span class="hljs-params">immediate</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <ul>
<li>Do not do anything if the connection is already closed</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._closed) {
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <ul>
<li>Collapsing multiple calls in a turn into a single deferred call</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (immediate) {
    <span class="hljs-keyword">this</span>._sendScheduled = <span class="hljs-literal">false</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._sendScheduled) {
      <span class="hljs-keyword">this</span>._sendScheduled = <span class="hljs-literal">true</span>;
      setImmediate(<span class="hljs-keyword">this</span>._send.bind(<span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>));
    }
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">this</span>._log.trace(<span class="hljs-string">'Starting forwarding frames from streams.'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <ul>
<li>Looping through priority <code>bucket</code>s in priority order.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>priority_loop:
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> priority <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>._streamPriorities) {
    <span class="hljs-keyword">var</span> bucket = <span class="hljs-keyword">this</span>._streamPriorities[priority];
    <span class="hljs-keyword">var</span> nextBucket = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <ul>
<li>Forwarding frames from buckets with round-robin scheduling.<ol>
<li>pulling out frame</li>
<li>if there’s no frame, skip this stream</li>
<li>if forwarding this frame would make <code>streamCount</code> greater than <code>streamLimit</code>, skip
this stream</li>
<li>adding stream to the bucket of the next round</li>
<li>assigning an ID to the frame (allocating an ID to the stream if there isn’t already)</li>
<li>if forwarding a PUSH_PROMISE, allocate ID to the promised stream</li>
<li>forwarding the frame, changing <code>streamCount</code> as appropriate</li>
<li>stepping to the next stream if there’s still more frame needed in the output buffer</li>
<li>switching to the bucket of the next round</li>
</ol>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">while</span> (bucket.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>; index &lt; bucket.length; index++) {
        <span class="hljs-keyword">var</span> stream = bucket[index];
        <span class="hljs-keyword">var</span> frame = stream.upstream.read((<span class="hljs-keyword">this</span>._window &gt; <span class="hljs-number">0</span>) ? <span class="hljs-keyword">this</span>._window : -<span class="hljs-number">1</span>);

        <span class="hljs-keyword">if</span> (!frame) {
          <span class="hljs-keyword">continue</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (frame.count_change &gt; <span class="hljs-keyword">this</span>._streamSlotsFree) {
          stream.upstream.unshift(frame);
          <span class="hljs-keyword">continue</span>;
        }

        nextBucket.push(stream);

        <span class="hljs-keyword">if</span> (frame.stream === <span class="hljs-literal">undefined</span>) {
          frame.stream = stream.id || <span class="hljs-keyword">this</span>._allocateId(stream);
        }

        <span class="hljs-keyword">if</span> (frame.type === <span class="hljs-string">'PUSH_PROMISE'</span>) {
          <span class="hljs-keyword">this</span>._allocatePriority(frame.promised_stream);
          frame.promised_stream = <span class="hljs-keyword">this</span>._allocateId(frame.promised_stream);
        }

        <span class="hljs-keyword">this</span>._log.trace({ s: stream, frame: frame }, <span class="hljs-string">'Forwarding outgoing frame'</span>);
        <span class="hljs-keyword">var</span> moreNeeded = <span class="hljs-keyword">this</span>.push(frame);
        <span class="hljs-keyword">this</span>._changeStreamCount(frame.count_change);

        assert(moreNeeded !== <span class="hljs-literal">null</span>); <span class="hljs-comment">// The frame shouldn't be unforwarded</span>
        <span class="hljs-keyword">if</span> (moreNeeded === <span class="hljs-literal">false</span>) {
          <span class="hljs-keyword">break</span> priority_loop;
        }
      }

      bucket = nextBucket;
      nextBucket = [];
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <ul>
<li>if we couldn’t forward any frame, then sleep until window update, or some other wakeup event</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (moreNeeded === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">this</span>.once(<span class="hljs-string">'wakeup'</span>, <span class="hljs-keyword">this</span>._send.bind(<span class="hljs-keyword">this</span>));
  }

  <span class="hljs-keyword">this</span>._log.trace({ moreNeeded: moreNeeded }, <span class="hljs-string">'Stopping forwarding frames from streams.'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>The <code>_receive</code> method is another virtual method of the <a href="flow.html">Flow class</a> that has to be
implemented by child classes. It forwards the given frame to the appropriate stream:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._receive = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_receive</span>(<span class="hljs-params">frame, done</span>) </span>{
  <span class="hljs-keyword">this</span>._log.trace({ frame: frame }, <span class="hljs-string">'Forwarding incoming frame'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <ul>
<li>first frame needs to be checked by the <code>_onFirstFrameReceived</code> method</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._firstFrameReceived) {
    <span class="hljs-keyword">this</span>._firstFrameReceived = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>._onFirstFrameReceived(frame);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Do some sanity checking here before we create a stream</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> ((frame.type == <span class="hljs-string">'SETTINGS'</span> ||
       frame.type == <span class="hljs-string">'PING'</span> ||
       frame.type == <span class="hljs-string">'GOAWAY'</span>) &amp;&amp;
      frame.stream != <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Got connection-level frame on a stream - EEP!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.close(<span class="hljs-string">'PROTOCOL_ERROR'</span>);
    <span class="hljs-keyword">return</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((frame.type == <span class="hljs-string">'DATA'</span> ||
              frame.type == <span class="hljs-string">'HEADERS'</span> ||
              frame.type == <span class="hljs-string">'PRIORITY'</span> ||
              frame.type == <span class="hljs-string">'RST_STREAM'</span> ||
              frame.type == <span class="hljs-string">'PUSH_PROMISE'</span> ||
              frame.type == <span class="hljs-string">'CONTINUATION'</span>) &amp;&amp;
             frame.stream == <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Got stream-level frame on connection - EEP!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.close(<span class="hljs-string">'PROTOCOL_ERROR'</span>);
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>WINDOW_UPDATE can be on either stream or connection</p>

            </div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <ul>
<li>gets the appropriate stream from the stream registry</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> stream = <span class="hljs-keyword">this</span>._streamIds[frame.stream];</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <ul>
<li>or creates one if it’s not in <code>this.streams</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!stream) {
    stream = <span class="hljs-keyword">this</span>._createIncomingStream(frame.stream);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <ul>
<li>in case of PUSH_PROMISE, replaces the promised stream id with a new incoming stream</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (frame.type === <span class="hljs-string">'PUSH_PROMISE'</span>) {
    frame.promised_stream = <span class="hljs-keyword">this</span>._createIncomingStream(frame.promised_stream);
  }

  frame.count_change = <span class="hljs-keyword">this</span>._changeStreamCount.bind(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <ul>
<li>and writes it to the <code>stream</code>‘s <code>upstream</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  stream.upstream.write(frame);

  done();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <h2 id="settings-management">Settings management</h2>

            </div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> defaultSettings = {
};</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Settings management initialization:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._initializeSettingsManagement = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initializeSettingsManagement</span>(<span class="hljs-params">settings</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <ul>
<li>Setting up the callback queue for setting acknowledgements</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._settingsAckCallbacks = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <ul>
<li>Sending the initial settings.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._log.debug({ settings: settings },
                  <span class="hljs-string">'Sending the first SETTINGS frame as part of the connection header.'</span>);
  <span class="hljs-keyword">this</span>.set(settings || defaultSettings);</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <ul>
<li>Forwarding SETTINGS frames to the <code>_receiveSettings</code> method</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'SETTINGS'</span>, <span class="hljs-keyword">this</span>._receiveSettings);
  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'RECEIVING_SETTINGS_MAX_FRAME_SIZE'</span>, <span class="hljs-keyword">this</span>._sanityCheckMaxFrameSize);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <ul>
<li>Checking that the first frame the other endpoint sends is SETTINGS</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._onFirstFrameReceived = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_onFirstFrameReceived</span>(<span class="hljs-params">frame</span>) </span>{
  <span class="hljs-keyword">if</span> ((frame.stream === <span class="hljs-number">0</span>) &amp;&amp; (frame.type === <span class="hljs-string">'SETTINGS'</span>)) {
    <span class="hljs-keyword">this</span>._log.debug(<span class="hljs-string">'Receiving the first SETTINGS frame as part of the connection header.'</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>._log.fatal({ frame: frame }, <span class="hljs-string">'Invalid connection header: first frame is not SETTINGS.'</span>);
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-string">'PROTOCOL_ERROR'</span>);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Handling of incoming SETTINGS frames.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._receiveSettings = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_receiveSettings</span>(<span class="hljs-params">frame</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <ul>
<li>If it’s an ACK, call the appropriate callback</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (frame.flags.ACK) {
    <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">this</span>._settingsAckCallbacks.shift();
    <span class="hljs-keyword">if</span> (callback) {
      callback();
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <ul>
<li>If it’s a setting change request, then send an ACK and change the appropriate settings</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._closed) {
      <span class="hljs-keyword">this</span>.push({
        type: <span class="hljs-string">'SETTINGS'</span>,
        flags: { ACK: <span class="hljs-literal">true</span> },
        stream: <span class="hljs-number">0</span>,
        settings: {}
      });
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> frame.settings) {
      <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'RECEIVING_'</span> + name, frame.settings[name]);
    }
  }
};

Connection.prototype._sanityCheckMaxFrameSize = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_sanityCheckMaxFrameSize</span>(<span class="hljs-params">value</span>) </span>{
  <span class="hljs-keyword">if</span> ((value &lt; <span class="hljs-number">0x4000</span>) || (value &gt;= <span class="hljs-number">0x01000000</span>)) {
    <span class="hljs-keyword">this</span>._log.fatal(<span class="hljs-string">'Received invalid value for max frame size: '</span> + value);
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Changing one or more settings value and sending out a SETTINGS frame</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype.set = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set</span>(<span class="hljs-params">settings, callback</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <ul>
<li>Calling the callback and emitting event when the change is acknowledges</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>._settingsAckCallbacks.push(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> settings) {
      self.emit(<span class="hljs-string">'ACKNOWLEDGED_'</span> + name, settings[name]);
    }
    <span class="hljs-keyword">if</span> (callback) {
      callback();
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <ul>
<li>Sending out the SETTINGS frame</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.push({
    type: <span class="hljs-string">'SETTINGS'</span>,
    flags: { ACK: <span class="hljs-literal">false</span> },
    stream: <span class="hljs-number">0</span>,
    settings: settings
  });
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> settings) {
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'SENDING_'</span> + name, settings[name]);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <h2 id="lifecycle-management">Lifecycle management</h2>

            </div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>The main responsibilities of lifecycle management code:</p>
<ul>
<li>keeping the connection alive by<ul>
<li>sending PINGs when the connection is idle</li>
<li>answering PINGs</li>
</ul>
</li>
<li>ending the connection</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Connection.prototype._initializeLifecycleManagement = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initializeLifecycleManagement</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>._pings = {};
  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'PING'</span>, <span class="hljs-keyword">this</span>._receivePing);
  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'GOAWAY'</span>, <span class="hljs-keyword">this</span>._receiveGoaway);
  <span class="hljs-keyword">this</span>._closed = <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Generating a string of length 16 with random hexadecimal digits</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._generatePingId = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_generatePingId</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">do</span> {
    <span class="hljs-keyword">var</span> id = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++) {
      id += <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random()*<span class="hljs-number">16</span>).toString(<span class="hljs-number">16</span>);
    }
  } <span class="hljs-keyword">while</span>(id <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>._pings);
  <span class="hljs-keyword">return</span> id;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Sending a ping and calling <code>callback</code> when the answer arrives</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype.ping = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ping</span>(<span class="hljs-params">callback</span>) </span>{
  <span class="hljs-keyword">var</span> id = <span class="hljs-keyword">this</span>._generatePingId();
  <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">new</span> Buffer(id, <span class="hljs-string">'hex'</span>);
  <span class="hljs-keyword">this</span>._pings[id] = callback;

  <span class="hljs-keyword">this</span>._log.debug({ data: data }, <span class="hljs-string">'Sending PING.'</span>);
  <span class="hljs-keyword">this</span>.push({
    type: <span class="hljs-string">'PING'</span>,
    flags: {
      ACK: <span class="hljs-literal">false</span>
    },
    stream: <span class="hljs-number">0</span>,
    data: data
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Answering pings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._receivePing = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_receivePing</span>(<span class="hljs-params">frame</span>) </span>{
  <span class="hljs-keyword">if</span> (frame.flags.ACK) {
    <span class="hljs-keyword">var</span> id = frame.data.toString(<span class="hljs-string">'hex'</span>);
    <span class="hljs-keyword">if</span> (id <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>._pings) {
      <span class="hljs-keyword">this</span>._log.debug({ data: frame.data }, <span class="hljs-string">'Receiving answer for a PING.'</span>);
      <span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">this</span>._pings[id];
      <span class="hljs-keyword">if</span> (callback) {
        callback();
      }
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._pings[id];
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>._log.warn({ data: frame.data }, <span class="hljs-string">'Unsolicited PING answer.'</span>);
    }

  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>._log.debug({ data: frame.data }, <span class="hljs-string">'Answering PING.'</span>);
    <span class="hljs-keyword">this</span>.push({
      type: <span class="hljs-string">'PING'</span>,
      flags: {
        ACK: <span class="hljs-literal">true</span>
      },
      stream: <span class="hljs-number">0</span>,
      data: frame.data
    });
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Terminating the connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype.close = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close</span>(<span class="hljs-params">error</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._closed) {
    <span class="hljs-keyword">this</span>._log.warn(<span class="hljs-string">'Trying to close an already closed connection'</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">this</span>._log.debug({ error: error }, <span class="hljs-string">'Closing the connection'</span>);
  <span class="hljs-keyword">this</span>.push({
    type: <span class="hljs-string">'GOAWAY'</span>,
    flags: {},
    stream: <span class="hljs-number">0</span>,
    last_stream: <span class="hljs-keyword">this</span>._lastIncomingStream,
    error: error || <span class="hljs-string">'NO_ERROR'</span>
  });
  <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">this</span>._closed = <span class="hljs-literal">true</span>;
};

Connection.prototype._receiveGoaway = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_receiveGoaway</span>(<span class="hljs-params">frame</span>) </span>{
  <span class="hljs-keyword">this</span>._log.debug({ error: frame.error }, <span class="hljs-string">'Other end closed the connection'</span>);
  <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">this</span>._closed = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">if</span> (frame.error !== <span class="hljs-string">'NO_ERROR'</span>) {
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'peerError'</span>, frame.error);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <h2 id="flow-control">Flow control</h2>

            </div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
Connection.prototype._initializeFlowControl = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initializeFlowControl</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Handling of initial window size of individual streams.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._initialStreamWindowSize = INITIAL_STREAM_WINDOW_SIZE;
  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'new_stream'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">stream</span>) </span>{
    stream.upstream.setInitialWindow(<span class="hljs-keyword">this</span>._initialStreamWindowSize);
  });
  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'RECEIVING_SETTINGS_INITIAL_WINDOW_SIZE'</span>, <span class="hljs-keyword">this</span>._setInitialStreamWindowSize);
  <span class="hljs-keyword">this</span>._streamIds[<span class="hljs-number">0</span>].upstream.setInitialWindow = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">noop</span>(<span class="hljs-params"></span>) </span>{};
};</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>The initial connection flow control window is 65535 bytes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> INITIAL_STREAM_WINDOW_SIZE = <span class="hljs-number">65535</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>A SETTINGS frame can alter the initial flow control window size for all current streams. When the
value of SETTINGS_INITIAL_WINDOW_SIZE changes, a receiver MUST adjust the window size of all
stream by calling the <code>setInitialStreamWindowSize</code> method. The window size has to be modified by
the difference between the new value and the old value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Connection.prototype._setInitialStreamWindowSize = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_setInitialStreamWindowSize</span>(<span class="hljs-params">size</span>) </span>{
  <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">this</span>._initialStreamWindowSize === <span class="hljs-literal">Infinity</span>) &amp;&amp; (size !== <span class="hljs-literal">Infinity</span>)) {
    <span class="hljs-keyword">this</span>._log.error(<span class="hljs-string">'Trying to manipulate initial flow control window size after flow control was turned off.'</span>);
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-string">'FLOW_CONTROL_ERROR'</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>._log.debug({ size: size }, <span class="hljs-string">'Changing stream initial window size.'</span>);
    <span class="hljs-keyword">this</span>._initialStreamWindowSize = size;
    <span class="hljs-keyword">this</span>._streamIds.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">stream</span>) </span>{
      stream.upstream.setInitialWindow(size);
    });
  }
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
