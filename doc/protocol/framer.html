<!DOCTYPE html>

<html>
<head>
  <title>framer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              <a class="source" href="../index.html">API</a>
              
                
                <a class="source" href="compressor.html">
                  compressor.js
                </a>
              
                
                <a class="source" href="connection.html">
                  connection.js
                </a>
              
                
                <a class="source" href="endpoint.html">
                  endpoint.js
                </a>
              
                
                <a class="source" href="flow.html">
                  flow.js
                </a>
              
                
                <a class="source" href="framer.html">
                  framer.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="stream.html">
                  stream.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>framer.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>The framer consists of two <a href="https://nodejs.org/api/stream.html#stream_class_stream_transform">Transform Stream</a> subclasses that operate in <a href="https://nodejs.org/api/stream.html#stream_new_stream_readable_options">object mode</a>:
the Serializer and the Deserializer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);

<span class="hljs-keyword">var</span> Transform = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Transform;

exports.Serializer = Serializer;
exports.Deserializer = Deserializer;

<span class="hljs-keyword">var</span> logData = <span class="hljs-built_in">Boolean</span>(process.env.HTTP2_LOG_DATA);

<span class="hljs-keyword">var</span> MAX_PAYLOAD_SIZE = <span class="hljs-number">16384</span>;
<span class="hljs-keyword">var</span> WINDOW_UPDATE_PAYLOAD_SIZE = <span class="hljs-number">4</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="serializer">Serializer</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <pre><code>Frame Objects
* * * * * * * --+---------------------------
                |                          |
                v                          v           Buffers
 [] -----&gt; Payload Ser. --[buffers]--&gt; Header Ser. --&gt; * * * *
empty      adds payload                adds header
array        buffers                     buffer
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Serializer</span>(<span class="hljs-params">log</span>) </span>{
  <span class="hljs-keyword">this</span>._log = log.child({ component: <span class="hljs-string">'serializer'</span> });
  Transform.call(<span class="hljs-keyword">this</span>, { objectMode: <span class="hljs-literal">true</span> });
}
Serializer.prototype = <span class="hljs-built_in">Object</span>.create(Transform.prototype, { constructor: { value: Serializer } });</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>When there’s an incoming frame object, it first generates the frame type specific part of the
frame (payload), and then then adds the header part which holds fields that are common to all
frame types (like the length of the payload).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Serializer.prototype._transform = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_transform</span>(<span class="hljs-params">frame, encoding, done</span>) </span>{
  <span class="hljs-keyword">this</span>._log.trace({ frame: frame }, <span class="hljs-string">'Outgoing frame'</span>);

  assert(frame.type <span class="hljs-keyword">in</span> Serializer, <span class="hljs-string">'Unknown frame type: '</span> + frame.type);

  <span class="hljs-keyword">var</span> buffers = [];
  Serializer[frame.type](frame, buffers);
  <span class="hljs-keyword">var</span> length = Serializer.commonHeader(frame, buffers);

  assert(length &lt;= MAX_PAYLOAD_SIZE, <span class="hljs-string">'Frame too large!'</span>);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; buffers.length; i++) {
    <span class="hljs-keyword">if</span> (logData) {
      <span class="hljs-keyword">this</span>._log.trace({ data: buffers[i] }, <span class="hljs-string">'Outgoing data'</span>);
    }
    <span class="hljs-keyword">this</span>.push(buffers[i]);
  }

  done();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="deserializer">Deserializer</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <pre><code>Buffers
* * * * --------+-------------------------
                |                        |
                v                        v           Frame Objects
 {} -----&gt; Header Des. --{frame}--&gt; Payload Des. --&gt; * * * * * * *
empty      adds parsed              adds parsed
object  header properties        payload properties
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Deserializer</span>(<span class="hljs-params">log, role</span>) </span>{
  <span class="hljs-keyword">this</span>._role = role;
  <span class="hljs-keyword">this</span>._log = log.child({ component: <span class="hljs-string">'deserializer'</span> });
  Transform.call(<span class="hljs-keyword">this</span>, { objectMode: <span class="hljs-literal">true</span> });
  <span class="hljs-keyword">this</span>._next(COMMON_HEADER_SIZE);
}
Deserializer.prototype = <span class="hljs-built_in">Object</span>.create(Transform.prototype, { constructor: { value: Deserializer } });</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The Deserializer is stateful, and it’s two main alternating states are: <em>waiting for header</em> and
<em>waiting for payload</em>. The state is stored in the boolean property <code>_waitingForHeader</code>.</p>
<p>When entering a new state, a <code>_buffer</code> is created that will hold the accumulated data (header or
payload). The <code>_cursor</code> is used to track the progress.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Deserializer.prototype._next = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">size</span>) </span>{
  <span class="hljs-keyword">this</span>._cursor = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">this</span>._buffer = <span class="hljs-keyword">new</span> Buffer(size);
  <span class="hljs-keyword">this</span>._waitingForHeader = !<span class="hljs-keyword">this</span>._waitingForHeader;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._waitingForHeader) {
    <span class="hljs-keyword">this</span>._frame = {};
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Parsing an incoming buffer is an iterative process because it can hold multiple frames if it’s
large enough. A <code>cursor</code> is used to track the progress in parsing the incoming <code>chunk</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Deserializer.prototype._transform = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_transform</span>(<span class="hljs-params">chunk, encoding, done</span>) </span>{
  <span class="hljs-keyword">var</span> cursor = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">if</span> (logData) {
    <span class="hljs-keyword">this</span>._log.trace({ data: chunk }, <span class="hljs-string">'Incoming data'</span>);
  }

  <span class="hljs-keyword">while</span>(cursor &lt; chunk.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>The content of an incoming buffer is first copied to <code>_buffer</code>. If it can’t hold the full
chunk, then only a part of it is copied.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> toCopy = <span class="hljs-built_in">Math</span>.min(chunk.length - cursor, <span class="hljs-keyword">this</span>._buffer.length - <span class="hljs-keyword">this</span>._cursor);
    chunk.copy(<span class="hljs-keyword">this</span>._buffer, <span class="hljs-keyword">this</span>._cursor, cursor, cursor + toCopy);
    <span class="hljs-keyword">this</span>._cursor += toCopy;
    cursor += toCopy;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>When <code>_buffer</code> is full, it’s content gets parsed either as header or payload depending on
the actual state.</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>If it’s header then the parsed data is stored in a temporary variable and then the
deserializer waits for the specified length payload.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">this</span>._cursor === <span class="hljs-keyword">this</span>._buffer.length) &amp;&amp; <span class="hljs-keyword">this</span>._waitingForHeader) {
      <span class="hljs-keyword">var</span> payloadSize = Deserializer.commonHeader(<span class="hljs-keyword">this</span>._buffer, <span class="hljs-keyword">this</span>._frame);
      <span class="hljs-keyword">if</span> (payloadSize &lt;= MAX_PAYLOAD_SIZE) {
        <span class="hljs-keyword">this</span>._next(payloadSize);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-string">'FRAME_SIZE_ERROR'</span>);
        <span class="hljs-keyword">return</span>;
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>If it’s payload then the the frame object is finalized and then gets pushed out.
Unknown frame types are ignored.</p>
<p>Note: If we just finished the parsing of a header and the payload length is 0, this branch
will also run.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">this</span>._cursor === <span class="hljs-keyword">this</span>._buffer.length) &amp;&amp; !<span class="hljs-keyword">this</span>._waitingForHeader) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._frame.type) {
        <span class="hljs-keyword">var</span> error = Deserializer[<span class="hljs-keyword">this</span>._frame.type](<span class="hljs-keyword">this</span>._buffer, <span class="hljs-keyword">this</span>._frame, <span class="hljs-keyword">this</span>._role);
        <span class="hljs-keyword">if</span> (error) {
          <span class="hljs-keyword">this</span>._log.error(<span class="hljs-string">'Incoming frame parsing error: '</span> + error);
          <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, error);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">this</span>._log.trace({ frame: <span class="hljs-keyword">this</span>._frame }, <span class="hljs-string">'Incoming frame'</span>);
          <span class="hljs-keyword">this</span>.push(<span class="hljs-keyword">this</span>._frame);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>._log.error(<span class="hljs-string">'Unknown type incoming frame'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Ignore it other than logging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      }
      <span class="hljs-keyword">this</span>._next(COMMON_HEADER_SIZE);
    }
  }

  done();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2 id="-frame-header-https-tools-ietf-org-html-rfc7540-section-4-1-"><a href="https://tools.ietf.org/html/rfc7540#section-4.1">Frame Header</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>HTTP/2 frames share a common base format consisting of a 9-byte header followed by 0 to 2^24 - 1
bytes of data.</p>
<p>Additional size limits can be set by specific application uses. HTTP limits the frame size to
16,384 octets by default, though this can be increased by a receiver.</p>
<pre><code> <span class="hljs-number">0</span>                   <span class="hljs-number">1</span>                   <span class="hljs-number">2</span>                   <span class="hljs-number">3</span>
 <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                 Length (<span class="hljs-number">24</span>)                   |
+---------------+---------------+---------------+
|   Type (<span class="hljs-number">8</span>)    |   Flags (<span class="hljs-number">8</span>)   |
+-+-----------------------------+---------------+---------------+
|R|                 Stream Identifier (<span class="hljs-number">31</span>)                      |
+-+-------------------------------------------------------------+
|                     Frame Data (<span class="hljs-number">0.</span>..)                       ...
+---------------------------------------------------------------+
</code></pre><p>The fields of the frame header are defined as:</p>
<ul>
<li><p>Length:
The length of the frame data expressed as an unsigned 24-bit integer. The 9 bytes of the frame
header are not included in this value.</p>
</li>
<li><p>Type:
The 8-bit type of the frame. The frame type determines how the remainder of the frame header
and data are interpreted. Implementations MUST ignore unsupported and unrecognized frame types.</p>
</li>
<li><p>Flags:
An 8-bit field reserved for frame-type specific boolean flags.</p>
<p>Flags are assigned semantics specific to the indicated frame type. Flags that have no defined
semantics for a particular frame type MUST be ignored, and MUST be left unset (0) when sending.</p>
</li>
<li><p>R:
A reserved 1-bit field. The semantics of this bit are undefined and the bit MUST remain unset
(0) when sending and MUST be ignored when receiving.</p>
</li>
<li><p>Stream Identifier:
A 31-bit stream identifier. The value 0 is reserved for frames that are associated with the
connection as a whole as opposed to an individual stream.</p>
</li>
</ul>
<p>The structure and content of the remaining frame data is dependent entirely on the frame type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> COMMON_HEADER_SIZE = <span class="hljs-number">9</span>;

<span class="hljs-keyword">var</span> frameTypes = [];

<span class="hljs-keyword">var</span> frameFlags = {};

<span class="hljs-keyword">var</span> genericAttributes = [<span class="hljs-string">'type'</span>, <span class="hljs-string">'flags'</span>, <span class="hljs-string">'stream'</span>];

<span class="hljs-keyword">var</span> typeSpecificAttributes = {};

Serializer.commonHeader = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeCommonHeader</span>(<span class="hljs-params">frame, buffers</span>) </span>{
  <span class="hljs-keyword">var</span> headerBuffer = <span class="hljs-keyword">new</span> Buffer(COMMON_HEADER_SIZE);

  <span class="hljs-keyword">var</span> size = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; buffers.length; i++) {
    size += buffers[i].length;
  }
  headerBuffer.writeUInt8(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
  headerBuffer.writeUInt16BE(size, <span class="hljs-number">1</span>);

  <span class="hljs-keyword">var</span> typeId = frameTypes.indexOf(frame.type);  <span class="hljs-comment">// If we are here then the type is valid for sure</span>
  headerBuffer.writeUInt8(typeId, <span class="hljs-number">3</span>);

  <span class="hljs-keyword">var</span> flagByte = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> flag <span class="hljs-keyword">in</span> frame.flags) {
    <span class="hljs-keyword">var</span> position = frameFlags[frame.type].indexOf(flag);
    assert(position !== -<span class="hljs-number">1</span>, <span class="hljs-string">'Unknown flag for frame type '</span> + frame.type + <span class="hljs-string">': '</span> + flag);
    <span class="hljs-keyword">if</span> (frame.flags[flag]) {
      flagByte |= (<span class="hljs-number">1</span> &lt;&lt; position);
    }
  }
  headerBuffer.writeUInt8(flagByte, <span class="hljs-number">4</span>);

  assert((<span class="hljs-number">0</span> &lt;= frame.stream) &amp;&amp; (frame.stream &lt; <span class="hljs-number">0x7fffffff</span>), frame.stream);
  headerBuffer.writeUInt32BE(frame.stream || <span class="hljs-number">0</span>, <span class="hljs-number">5</span>);

  buffers.unshift(headerBuffer);

  <span class="hljs-keyword">return</span> size;
};

Deserializer.commonHeader = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readCommonHeader</span>(<span class="hljs-params">buffer, frame</span>) </span>{
  <span class="hljs-keyword">if</span> (buffer.length &lt; <span class="hljs-number">9</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
  }

  <span class="hljs-keyword">var</span> totallyWastedByte = buffer.readUInt8(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">var</span> length = buffer.readUInt16BE(<span class="hljs-number">1</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>We do this just for sanity checking later on, to make sure no one sent us a
frame that’s super large.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  length += totallyWastedByte &lt;&lt; <span class="hljs-number">16</span>;

  frame.type = frameTypes[buffer.readUInt8(<span class="hljs-number">3</span>)];
  <span class="hljs-keyword">if</span> (!frame.type) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>We are required to ignore unknown frame types</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> length;
  }

  frame.flags = {};
  <span class="hljs-keyword">var</span> flagByte = buffer.readUInt8(<span class="hljs-number">4</span>);
  <span class="hljs-keyword">var</span> definedFlags = frameFlags[frame.type];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; definedFlags.length; i++) {
    frame.flags[definedFlags[i]] = <span class="hljs-built_in">Boolean</span>(flagByte &amp; (<span class="hljs-number">1</span> &lt;&lt; i));
  }

  frame.stream = buffer.readUInt32BE(<span class="hljs-number">5</span>) &amp; <span class="hljs-number">0x7fffffff</span>;

  <span class="hljs-keyword">return</span> length;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h1 id="frame-types">Frame types</h1>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Every frame type is registered in the following places:</p>
<ul>
<li><code>frameTypes</code>: a register of frame type codes (used by <code>commonHeader()</code>)</li>
<li><code>frameFlags</code>: a register of valid flags for frame types (used by <code>commonHeader()</code>)</li>
<li><code>typeSpecificAttributes</code>: a register of frame specific frame object attributes (used by
logging code and also serves as documentation for frame objects)</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2 id="-data-frames-https-tools-ietf-org-html-rfc7540-section-6-1-"><a href="https://tools.ietf.org/html/rfc7540#section-6.1">DATA Frames</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>DATA frames (type=0x0) convey arbitrary, variable-length sequences of octets associated with a
stream.</p>
<p>The DATA frame defines the following flags:</p>
<ul>
<li>END_STREAM (0x1):
Bit 1 being set indicates that this frame is the last that the endpoint will send for the
identified stream.</li>
<li>PADDED (0x08):
Bit 4 being set indicates that the Pad Length field is present.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
frameTypes[<span class="hljs-number">0x0</span>] = <span class="hljs-string">'DATA'</span>;

frameFlags.DATA = [<span class="hljs-string">'END_STREAM'</span>, <span class="hljs-string">'RESERVED2'</span>, <span class="hljs-string">'RESERVED4'</span>, <span class="hljs-string">'PADDED'</span>];

typeSpecificAttributes.DATA = [<span class="hljs-string">'data'</span>];

Serializer.DATA = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeData</span>(<span class="hljs-params">frame, buffers</span>) </span>{
  buffers.push(frame.data);
};

Deserializer.DATA = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readData</span>(<span class="hljs-params">buffer, frame</span>) </span>{
  <span class="hljs-keyword">var</span> dataOffset = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> paddingLength = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (frame.flags.PADDED) {
    <span class="hljs-keyword">if</span> (buffer.length &lt; <span class="hljs-number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>We must have at least one byte for padding control, but we don’t. Bad peer!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
    }
    paddingLength = (buffer.readUInt8(dataOffset) &amp; <span class="hljs-number">0xff</span>);
    dataOffset = <span class="hljs-number">1</span>;
  }

  <span class="hljs-keyword">if</span> (paddingLength) {
    <span class="hljs-keyword">if</span> (paddingLength &gt;= (buffer.length - <span class="hljs-number">1</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>We don’t have enough room for the padding advertised - bad peer!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
    }
    frame.data = buffer.slice(dataOffset, -<span class="hljs-number">1</span> * paddingLength);
  } <span class="hljs-keyword">else</span> {
    frame.data = buffer.slice(dataOffset);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h2 id="-headers-https-tools-ietf-org-html-rfc7540-section-6-2-"><a href="https://tools.ietf.org/html/rfc7540#section-6.2">HEADERS</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>The HEADERS frame (type=0x1) allows the sender to create a stream.</p>
<p>The HEADERS frame defines the following flags:</p>
<ul>
<li>END_STREAM (0x1):
Bit 1 being set indicates that this frame is the last that the endpoint will send for the
identified stream.</li>
<li>END_HEADERS (0x4):
The END_HEADERS bit indicates that this frame contains the entire payload necessary to provide
a complete set of headers.</li>
<li>PADDED (0x08):
Bit 4 being set indicates that the Pad Length field is present.</li>
<li>PRIORITY (0x20):
Bit 6 being set indicates that the Exlusive Flag (E), Stream Dependency, and Weight fields are
present.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
frameTypes[<span class="hljs-number">0x1</span>] = <span class="hljs-string">'HEADERS'</span>;

frameFlags.HEADERS = [<span class="hljs-string">'END_STREAM'</span>, <span class="hljs-string">'RESERVED2'</span>, <span class="hljs-string">'END_HEADERS'</span>, <span class="hljs-string">'PADDED'</span>, <span class="hljs-string">'RESERVED5'</span>, <span class="hljs-string">'PRIORITY'</span>];

typeSpecificAttributes.HEADERS = [<span class="hljs-string">'priorityDependency'</span>, <span class="hljs-string">'priorityWeight'</span>, <span class="hljs-string">'exclusiveDependency'</span>, <span class="hljs-string">'headers'</span>, <span class="hljs-string">'data'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <pre><code> <span class="hljs-number">0</span>                   <span class="hljs-number">1</span>                   <span class="hljs-number">2</span>                   <span class="hljs-number">3</span>
 <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Pad Length? (<span class="hljs-number">8</span>)|
+-+-------------+---------------+-------------------------------+
|E|                 Stream Dependency? (<span class="hljs-number">31</span>)                     |
+-+-------------+-----------------------------------------------+
|  Weight? (<span class="hljs-number">8</span>)  |
+-+-------------+-----------------------------------------------+
|                   Header Block Fragment (*)                 ...
+---------------------------------------------------------------+
|                           Padding (*)                       ...
+---------------------------------------------------------------+
</code></pre><p>The payload of a HEADERS frame contains a Headers Block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Serializer.HEADERS = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeHeadersPriority</span>(<span class="hljs-params">frame, buffers</span>) </span>{
  <span class="hljs-keyword">if</span> (frame.flags.PRIORITY) {
    <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">5</span>);
    assert((<span class="hljs-number">0</span> &lt;= frame.priorityDependency) &amp;&amp; (frame.priorityDependency &lt;= <span class="hljs-number">0x7fffffff</span>), frame.priorityDependency);
    buffer.writeUInt32BE(frame.priorityDependency, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (frame.exclusiveDependency) {
      buffer[<span class="hljs-number">0</span>] |= <span class="hljs-number">0x80</span>;
    }
    assert((<span class="hljs-number">0</span> &lt;= frame.priorityWeight) &amp;&amp; (frame.priorityWeight &lt;= <span class="hljs-number">0xff</span>), frame.priorityWeight);
    buffer.writeUInt8(frame.priorityWeight, <span class="hljs-number">4</span>);
    buffers.push(buffer);
  }
  buffers.push(frame.data);
};

Deserializer.HEADERS = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readHeadersPriority</span>(<span class="hljs-params">buffer, frame</span>) </span>{
  <span class="hljs-keyword">var</span> minFrameLength = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (frame.flags.PADDED) {
    minFrameLength += <span class="hljs-number">1</span>;
  }
  <span class="hljs-keyword">if</span> (frame.flags.PRIORITY) {
    minFrameLength += <span class="hljs-number">5</span>;
  }
  <span class="hljs-keyword">if</span> (buffer.length &lt; minFrameLength) {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Peer didn’t send enough data - bad peer!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
  }

  <span class="hljs-keyword">var</span> dataOffset = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> paddingLength = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (frame.flags.PADDED) {
    paddingLength = (buffer.readUInt8(dataOffset) &amp; <span class="hljs-number">0xff</span>);
    dataOffset = <span class="hljs-number">1</span>;
  }

  <span class="hljs-keyword">if</span> (frame.flags.PRIORITY) {
    <span class="hljs-keyword">var</span> dependencyData = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">4</span>);
    buffer.copy(dependencyData, <span class="hljs-number">0</span>, dataOffset, dataOffset + <span class="hljs-number">4</span>);
    dataOffset += <span class="hljs-number">4</span>;
    frame.exclusiveDependency = !!(dependencyData[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x80</span>);
    dependencyData[<span class="hljs-number">0</span>] &amp;= <span class="hljs-number">0x7f</span>;
    frame.priorityDependency = dependencyData.readUInt32BE(<span class="hljs-number">0</span>);
    frame.priorityWeight = buffer.readUInt8(dataOffset);
    dataOffset += <span class="hljs-number">1</span>;
  }

  <span class="hljs-keyword">if</span> (paddingLength) {
    <span class="hljs-keyword">if</span> ((buffer.length - dataOffset) &lt; paddingLength) {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Not enough data left to satisfy the advertised padding - bad peer!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
    }
    frame.data = buffer.slice(dataOffset, -<span class="hljs-number">1</span> * paddingLength);
  } <span class="hljs-keyword">else</span> {
    frame.data = buffer.slice(dataOffset);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h2 id="-priority-https-tools-ietf-org-html-rfc7540-section-6-3-"><a href="https://tools.ietf.org/html/rfc7540#section-6.3">PRIORITY</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>The PRIORITY frame (type=0x2) specifies the sender-advised priority of a stream.</p>
<p>The PRIORITY frame does not define any flags.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
frameTypes[<span class="hljs-number">0x2</span>] = <span class="hljs-string">'PRIORITY'</span>;

frameFlags.PRIORITY = [];

typeSpecificAttributes.PRIORITY = [<span class="hljs-string">'priorityDependency'</span>, <span class="hljs-string">'priorityWeight'</span>, <span class="hljs-string">'exclusiveDependency'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <pre><code> <span class="hljs-number">0</span>                   <span class="hljs-number">1</span>                   <span class="hljs-number">2</span>                   <span class="hljs-number">3</span>
 <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|E|                 Stream Dependency? (<span class="hljs-number">31</span>)                     |
+-+-------------+-----------------------------------------------+
|  Weight? (<span class="hljs-number">8</span>)  |
+-+-------------+
</code></pre><p>The payload of a PRIORITY frame contains an exclusive bit, a 31-bit dependency, and an 8-bit weight</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Serializer.PRIORITY = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writePriority</span>(<span class="hljs-params">frame, buffers</span>) </span>{
  <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">5</span>);
  assert((<span class="hljs-number">0</span> &lt;= frame.priorityDependency) &amp;&amp; (frame.priorityDependency &lt;= <span class="hljs-number">0x7fffffff</span>), frame.priorityDependency);
  buffer.writeUInt32BE(frame.priorityDependency, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">if</span> (frame.exclusiveDependency) {
    buffer[<span class="hljs-number">0</span>] |= <span class="hljs-number">0x80</span>;
  }
  assert((<span class="hljs-number">0</span> &lt;= frame.priorityWeight) &amp;&amp; (frame.priorityWeight &lt;= <span class="hljs-number">0xff</span>), frame.priorityWeight);
  buffer.writeUInt8(frame.priorityWeight, <span class="hljs-number">4</span>);

  buffers.push(buffer);
};

Deserializer.PRIORITY = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readPriority</span>(<span class="hljs-params">buffer, frame</span>) </span>{
  <span class="hljs-keyword">if</span> (buffer.length &lt; <span class="hljs-number">5</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>PRIORITY frames are 5 bytes long. Bad peer!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
  }
  <span class="hljs-keyword">var</span> dependencyData = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">4</span>);
  buffer.copy(dependencyData, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);
  frame.exclusiveDependency = !!(dependencyData[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x80</span>);
  dependencyData[<span class="hljs-number">0</span>] &amp;= <span class="hljs-number">0x7f</span>;
  frame.priorityDependency = dependencyData.readUInt32BE(<span class="hljs-number">0</span>);
  frame.priorityWeight = buffer.readUInt8(<span class="hljs-number">4</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h2 id="-rst_stream-https-tools-ietf-org-html-rfc7540-section-6-4-"><a href="https://tools.ietf.org/html/rfc7540#section-6.4">RST_STREAM</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>The RST_STREAM frame (type=0x3) allows for abnormal termination of a stream.</p>
<p>No type-flags are defined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
frameTypes[<span class="hljs-number">0x3</span>] = <span class="hljs-string">'RST_STREAM'</span>;

frameFlags.RST_STREAM = [];

typeSpecificAttributes.RST_STREAM = [<span class="hljs-string">'error'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <pre><code> <span class="hljs-number">0</span>                   <span class="hljs-number">1</span>                   <span class="hljs-number">2</span>                   <span class="hljs-number">3</span>
 <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         <span class="hljs-built_in">Error</span> Code (<span class="hljs-number">32</span>)                       |
+---------------------------------------------------------------+
</code></pre><p>The RST_STREAM frame contains a single unsigned, 32-bit integer identifying the error
code (see Error Codes). The error code indicates why the stream is being terminated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Serializer.RST_STREAM = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeRstStream</span>(<span class="hljs-params">frame, buffers</span>) </span>{
  <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">4</span>);
  <span class="hljs-keyword">var</span> code = errorCodes.indexOf(frame.error);
  assert((<span class="hljs-number">0</span> &lt;= code) &amp;&amp; (code &lt;= <span class="hljs-number">0xffffffff</span>), code);
  buffer.writeUInt32BE(code, <span class="hljs-number">0</span>);
  buffers.push(buffer);
};

Deserializer.RST_STREAM = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readRstStream</span>(<span class="hljs-params">buffer, frame</span>) </span>{
  <span class="hljs-keyword">if</span> (buffer.length &lt; <span class="hljs-number">4</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>RST_STREAM is 4 bytes long. Bad peer!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
  }
  frame.error = errorCodes[buffer.readUInt32BE(<span class="hljs-number">0</span>)];
  <span class="hljs-keyword">if</span> (!frame.error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Unknown error codes are considered equivalent to INTERNAL_ERROR</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    frame.error = <span class="hljs-string">'INTERNAL_ERROR'</span>;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h2 id="-settings-https-tools-ietf-org-html-rfc7540-section-6-5-"><a href="https://tools.ietf.org/html/rfc7540#section-6.5">SETTINGS</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>The SETTINGS frame (type=0x4) conveys configuration parameters that affect how endpoints
communicate.</p>
<p>The SETTINGS frame defines the following flag:</p>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <ul>
<li>ACK (0x1):
Bit 1 being set indicates that this frame acknowledges receipt and application of the peer’s
SETTINGS frame.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>frameTypes[<span class="hljs-number">0x4</span>] = <span class="hljs-string">'SETTINGS'</span>;

frameFlags.SETTINGS = [<span class="hljs-string">'ACK'</span>];

typeSpecificAttributes.SETTINGS = [<span class="hljs-string">'settings'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>The payload of a SETTINGS frame consists of zero or more settings. Each setting consists of a
16-bit identifier, and an unsigned 32-bit value.</p>
<pre><code> <span class="hljs-number">0</span>                   <span class="hljs-number">1</span>                   <span class="hljs-number">2</span>                   <span class="hljs-number">3</span>
 <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identifier(<span class="hljs-number">16</span>)          |        Value (<span class="hljs-number">32</span>)           |
+-----------------+---------------------------------------------+
...Value                          |
+---------------------------------+
</code></pre><p>Each setting in a SETTINGS frame replaces the existing value for that setting.  Settings are
processed in the order in which they appear, and a receiver of a SETTINGS frame does not need to
maintain any state other than the current value of settings.  Therefore, the value of a setting
is the last value that is seen by a receiver. This permits the inclusion of the same settings
multiple times in the same SETTINGS frame, though doing so does nothing other than waste
connection capacity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Serializer.SETTINGS = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeSettings</span>(<span class="hljs-params">frame, buffers</span>) </span>{
  <span class="hljs-keyword">var</span> settings = [], settingsLeft = <span class="hljs-built_in">Object</span>.keys(frame.settings);
  definedSettings.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">setting, id</span>) </span>{
    <span class="hljs-keyword">if</span> (setting.name <span class="hljs-keyword">in</span> frame.settings) {
      settingsLeft.splice(settingsLeft.indexOf(setting.name), <span class="hljs-number">1</span>);
      <span class="hljs-keyword">var</span> value = frame.settings[setting.name];
      settings.push({ id: id, value: setting.flag ? <span class="hljs-built_in">Boolean</span>(value) : value });
    }
  });
  assert(settingsLeft.length === <span class="hljs-number">0</span>, <span class="hljs-string">'Unknown settings: '</span> + settingsLeft.join(<span class="hljs-string">', '</span>));

  <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> Buffer(settings.length * <span class="hljs-number">6</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; settings.length; i++) {
    buffer.writeUInt16BE(settings[i].id &amp; <span class="hljs-number">0xffff</span>, i*<span class="hljs-number">6</span>);
    buffer.writeUInt32BE(settings[i].value, i*<span class="hljs-number">6</span> + <span class="hljs-number">2</span>);
  }

  buffers.push(buffer);
};

Deserializer.SETTINGS = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readSettings</span>(<span class="hljs-params">buffer, frame, role</span>) </span>{
  frame.settings = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Receipt of a SETTINGS frame with the ACK flag set and a length
field value other than 0 MUST be treated as a connection error
(Section 5.4.1) of type FRAME_SIZE_ERROR.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(frame.flags.ACK &amp;&amp; buffer.length != <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
  }

  <span class="hljs-keyword">if</span> (buffer.length % <span class="hljs-number">6</span> !== <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'PROTOCOL_ERROR'</span>;
  }
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; buffer.length / <span class="hljs-number">6</span>; i++) {
    <span class="hljs-keyword">var</span> id = buffer.readUInt16BE(i*<span class="hljs-number">6</span>) &amp; <span class="hljs-number">0xffff</span>;
    <span class="hljs-keyword">var</span> setting = definedSettings[id];
    <span class="hljs-keyword">if</span> (setting) {
      <span class="hljs-keyword">if</span> (role == <span class="hljs-string">'CLIENT'</span> &amp;&amp; setting.name == <span class="hljs-string">'SETTINGS_ENABLE_PUSH'</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">'SETTINGS frame on client got SETTINGS_ENABLE_PUSH'</span>;
      }
      <span class="hljs-keyword">var</span> value = buffer.readUInt32BE(i*<span class="hljs-number">6</span> + <span class="hljs-number">2</span>);
      frame.settings[setting.name] = setting.flag ? <span class="hljs-built_in">Boolean</span>(value &amp; <span class="hljs-number">0x1</span>) : value;
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>The following settings are defined:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> definedSettings = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <ul>
<li>SETTINGS_HEADER_TABLE_SIZE (1):
Allows the sender to inform the remote endpoint of the size of the header compression table
used to decode header blocks.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>definedSettings[<span class="hljs-number">1</span>] = { name: <span class="hljs-string">'SETTINGS_HEADER_TABLE_SIZE'</span>, flag: <span class="hljs-literal">false</span> };</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <ul>
<li>SETTINGS_ENABLE_PUSH (2):
This setting can be use to disable server push. An endpoint MUST NOT send a PUSH_PROMISE frame
if it receives this setting set to a value of 0. The default value is 1, which indicates that
push is permitted.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>definedSettings[<span class="hljs-number">2</span>] = { name: <span class="hljs-string">'SETTINGS_ENABLE_PUSH'</span>, flag: <span class="hljs-literal">true</span> };</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <ul>
<li>SETTINGS_MAX_CONCURRENT_STREAMS (3):
indicates the maximum number of concurrent streams that the sender will allow.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>definedSettings[<span class="hljs-number">3</span>] = { name: <span class="hljs-string">'SETTINGS_MAX_CONCURRENT_STREAMS'</span>, flag: <span class="hljs-literal">false</span> };</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <ul>
<li>SETTINGS_INITIAL_WINDOW_SIZE (4):
indicates the sender’s initial stream window size (in bytes) for new streams.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>definedSettings[<span class="hljs-number">4</span>] = { name: <span class="hljs-string">'SETTINGS_INITIAL_WINDOW_SIZE'</span>, flag: <span class="hljs-literal">false</span> };</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <ul>
<li>SETTINGS_MAX_FRAME_SIZE (5):
indicates the maximum size of a frame the receiver will allow.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>definedSettings[<span class="hljs-number">5</span>] = { name: <span class="hljs-string">'SETTINGS_MAX_FRAME_SIZE'</span>, flag: <span class="hljs-literal">false</span> };</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <h2 id="-push_promise-https-tools-ietf-org-html-rfc7540-section-6-6-"><a href="https://tools.ietf.org/html/rfc7540#section-6.6">PUSH_PROMISE</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>The PUSH_PROMISE frame (type=0x5) is used to notify the peer endpoint in advance of streams the
sender intends to initiate.</p>
<p>The PUSH_PROMISE frame defines the following flags:</p>
<ul>
<li>END_PUSH_PROMISE (0x4):
The END_PUSH_PROMISE bit indicates that this frame contains the entire payload necessary to
provide a complete set of headers.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
frameTypes[<span class="hljs-number">0x5</span>] = <span class="hljs-string">'PUSH_PROMISE'</span>;

frameFlags.PUSH_PROMISE = [<span class="hljs-string">'RESERVED1'</span>, <span class="hljs-string">'RESERVED2'</span>, <span class="hljs-string">'END_PUSH_PROMISE'</span>, <span class="hljs-string">'PADDED'</span>];

typeSpecificAttributes.PUSH_PROMISE = [<span class="hljs-string">'promised_stream'</span>, <span class="hljs-string">'headers'</span>, <span class="hljs-string">'data'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <pre><code> <span class="hljs-number">0</span>                   <span class="hljs-number">1</span>                   <span class="hljs-number">2</span>                   <span class="hljs-number">3</span>
 <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Pad Length? (<span class="hljs-number">8</span>)|
+-+-------------+-----------------------------------------------+
|X|                Promised-Stream-ID (<span class="hljs-number">31</span>)                      |
+-+-------------------------------------------------------------+
|                 Header Block Fragment (*)                   ...
+---------------------------------------------------------------+
|                         Padding (*)                         ...
+---------------------------------------------------------------+
</code></pre><p>The PUSH_PROMISE frame includes the unsigned 31-bit identifier of
the stream the endpoint plans to create along with a minimal set of headers that provide
additional context for the stream.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Serializer.PUSH_PROMISE = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writePushPromise</span>(<span class="hljs-params">frame, buffers</span>) </span>{
  <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">4</span>);

  <span class="hljs-keyword">var</span> promised_stream = frame.promised_stream;
  assert((<span class="hljs-number">0</span> &lt;= promised_stream) &amp;&amp; (promised_stream &lt;= <span class="hljs-number">0x7fffffff</span>), promised_stream);
  buffer.writeUInt32BE(promised_stream, <span class="hljs-number">0</span>);

  buffers.push(buffer);
  buffers.push(frame.data);
};

Deserializer.PUSH_PROMISE = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readPushPromise</span>(<span class="hljs-params">buffer, frame</span>) </span>{
  <span class="hljs-keyword">if</span> (buffer.length &lt; <span class="hljs-number">4</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
  }
  <span class="hljs-keyword">var</span> dataOffset = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> paddingLength = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (frame.flags.PADDED) {
    <span class="hljs-keyword">if</span> (buffer.length &lt; <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
    }
    paddingLength = (buffer.readUInt8(dataOffset) &amp; <span class="hljs-number">0xff</span>);
    dataOffset = <span class="hljs-number">1</span>;
  }
  frame.promised_stream = buffer.readUInt32BE(dataOffset) &amp; <span class="hljs-number">0x7fffffff</span>;
  dataOffset += <span class="hljs-number">4</span>;
  <span class="hljs-keyword">if</span> (paddingLength) {
    <span class="hljs-keyword">if</span> ((buffer.length - dataOffset) &lt; paddingLength) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
    }
    frame.data = buffer.slice(dataOffset, -<span class="hljs-number">1</span> * paddingLength);
  } <span class="hljs-keyword">else</span> {
    frame.data = buffer.slice(dataOffset);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <h2 id="-ping-https-tools-ietf-org-html-rfc7540-section-6-7-"><a href="https://tools.ietf.org/html/rfc7540#section-6.7">PING</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>The PING frame (type=0x6) is a mechanism for measuring a minimal round-trip time from the
sender, as well as determining whether an idle connection is still functional.</p>
<p>The PING frame defines one type-specific flag:</p>
<ul>
<li>ACK (0x1):
Bit 1 being set indicates that this PING frame is a PING response.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
frameTypes[<span class="hljs-number">0x6</span>] = <span class="hljs-string">'PING'</span>;

frameFlags.PING = [<span class="hljs-string">'ACK'</span>];

typeSpecificAttributes.PING = [<span class="hljs-string">'data'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>In addition to the frame header, PING frames MUST contain 8 additional octets of opaque data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Serializer.PING = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writePing</span>(<span class="hljs-params">frame, buffers</span>) </span>{
  buffers.push(frame.data);
};

Deserializer.PING = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readPing</span>(<span class="hljs-params">buffer, frame</span>) </span>{
  <span class="hljs-keyword">if</span> (buffer.length !== <span class="hljs-number">8</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
  }
  frame.data = buffer;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <h2 id="-goaway-https-tools-ietf-org-html-rfc7540-section-6-8-"><a href="https://tools.ietf.org/html/rfc7540#section-6.8">GOAWAY</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>The GOAWAY frame (type=0x7) informs the remote peer to stop creating streams on this connection.</p>
<p>The GOAWAY frame does not define any flags.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
frameTypes[<span class="hljs-number">0x7</span>] = <span class="hljs-string">'GOAWAY'</span>;

frameFlags.GOAWAY = [];

typeSpecificAttributes.GOAWAY = [<span class="hljs-string">'last_stream'</span>, <span class="hljs-string">'error'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <pre><code> <span class="hljs-number">0</span>                   <span class="hljs-number">1</span>                   <span class="hljs-number">2</span>                   <span class="hljs-number">3</span>
 <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|X|                  Last-Stream-ID (<span class="hljs-number">31</span>)                        |
+-+-------------------------------------------------------------+
|                      <span class="hljs-built_in">Error</span> Code (<span class="hljs-number">32</span>)                          |
+---------------------------------------------------------------+
</code></pre><p>The last stream identifier in the GOAWAY frame contains the highest numbered stream identifier
for which the sender of the GOAWAY frame has received frames on and might have taken some action
on.</p>
<p>The GOAWAY frame also contains a 32-bit error code (see Error Codes) that contains the reason for
closing the connection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Serializer.GOAWAY = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeGoaway</span>(<span class="hljs-params">frame, buffers</span>) </span>{
  <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">8</span>);

  <span class="hljs-keyword">var</span> last_stream = frame.last_stream;
  assert((<span class="hljs-number">0</span> &lt;= last_stream) &amp;&amp; (last_stream &lt;= <span class="hljs-number">0x7fffffff</span>), last_stream);
  buffer.writeUInt32BE(last_stream, <span class="hljs-number">0</span>);

  <span class="hljs-keyword">var</span> code = errorCodes.indexOf(frame.error);
  assert((<span class="hljs-number">0</span> &lt;= code) &amp;&amp; (code &lt;= <span class="hljs-number">0xffffffff</span>), code);
  buffer.writeUInt32BE(code, <span class="hljs-number">4</span>);

  buffers.push(buffer);
};

Deserializer.GOAWAY = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readGoaway</span>(<span class="hljs-params">buffer, frame</span>) </span>{
  <span class="hljs-keyword">if</span> (buffer.length !== <span class="hljs-number">8</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>GOAWAY must have 8 bytes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
  }
  frame.last_stream = buffer.readUInt32BE(<span class="hljs-number">0</span>) &amp; <span class="hljs-number">0x7fffffff</span>;
  frame.error = errorCodes[buffer.readUInt32BE(<span class="hljs-number">4</span>)];
  <span class="hljs-keyword">if</span> (!frame.error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Unknown error types are to be considered equivalent to INTERNAL ERROR</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    frame.error = <span class="hljs-string">'INTERNAL_ERROR'</span>;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <h2 id="-window_update-https-tools-ietf-org-html-rfc7540-section-6-9-"><a href="https://tools.ietf.org/html/rfc7540#section-6.9">WINDOW_UPDATE</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>The WINDOW_UPDATE frame (type=0x8) is used to implement flow control.</p>
<p>The WINDOW_UPDATE frame does not define any flags.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
frameTypes[<span class="hljs-number">0x8</span>] = <span class="hljs-string">'WINDOW_UPDATE'</span>;

frameFlags.WINDOW_UPDATE = [];

typeSpecificAttributes.WINDOW_UPDATE = [<span class="hljs-string">'window_size'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>The payload of a WINDOW_UPDATE frame is a 32-bit value indicating the additional number of bytes
that the sender can transmit in addition to the existing flow control window. The legal range
for this field is 1 to 2^31 - 1 (0x7fffffff) bytes; the most significant bit of this value is
reserved.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Serializer.WINDOW_UPDATE = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeWindowUpdate</span>(<span class="hljs-params">frame, buffers</span>) </span>{
  <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">4</span>);

  <span class="hljs-keyword">var</span> window_size = frame.window_size;
  assert((<span class="hljs-number">0</span> &lt; window_size) &amp;&amp; (window_size &lt;= <span class="hljs-number">0x7fffffff</span>), window_size);
  buffer.writeUInt32BE(window_size, <span class="hljs-number">0</span>);

  buffers.push(buffer);
};

Deserializer.WINDOW_UPDATE = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readWindowUpdate</span>(<span class="hljs-params">buffer, frame</span>) </span>{
  <span class="hljs-keyword">if</span> (buffer.length !== WINDOW_UPDATE_PAYLOAD_SIZE) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
  }
  frame.window_size = buffer.readUInt32BE(<span class="hljs-number">0</span>) &amp; <span class="hljs-number">0x7fffffff</span>;
  <span class="hljs-keyword">if</span> (frame.window_size === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'PROTOCOL_ERROR'</span>;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <h2 id="-continuation-https-tools-ietf-org-html-rfc7540-section-6-10-"><a href="https://tools.ietf.org/html/rfc7540#section-6.10">CONTINUATION</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>The CONTINUATION frame (type=0x9) is used to continue a sequence of header block fragments.</p>
<p>The CONTINUATION frame defines the following flag:</p>
<ul>
<li>END_HEADERS (0x4):
The END_HEADERS bit indicates that this frame ends the sequence of header block fragments
necessary to provide a complete set of headers.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
frameTypes[<span class="hljs-number">0x9</span>] = <span class="hljs-string">'CONTINUATION'</span>;

frameFlags.CONTINUATION = [<span class="hljs-string">'RESERVED1'</span>, <span class="hljs-string">'RESERVED2'</span>, <span class="hljs-string">'END_HEADERS'</span>];

typeSpecificAttributes.CONTINUATION = [<span class="hljs-string">'headers'</span>, <span class="hljs-string">'data'</span>];

Serializer.CONTINUATION = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeContinuation</span>(<span class="hljs-params">frame, buffers</span>) </span>{
  buffers.push(frame.data);
};

Deserializer.CONTINUATION = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readContinuation</span>(<span class="hljs-params">buffer, frame</span>) </span>{
  frame.data = buffer;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <h2 id="-altsvc-https-tools-ietf-org-html-rfc7838-section-4-"><a href="https://tools.ietf.org/html/rfc7838#section-4">ALTSVC</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>The ALTSVC frame (type=0xA) advertises the availability of an alternative service to the client.</p>
<p>The ALTSVC frame does not define any flags.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
frameTypes[<span class="hljs-number">0xA</span>] = <span class="hljs-string">'ALTSVC'</span>;

frameFlags.ALTSVC = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <pre><code><span class="hljs-number">0</span>                   <span class="hljs-number">1</span>                   <span class="hljs-number">2</span>                   <span class="hljs-number">3</span>
<span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>
</code></pre><p>   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Origin-Len (16)       | Origin? (<em>)                 …
   +——————————-+—————-+————–+
   |                   Alt-Svc-Field-Value (</em>)                   …
   +—————————————————————+</p>
<p>The ALTSVC frame contains the following fields:</p>
<p>Origin-Len: An unsigned, 16-bit integer indicating the length, in
   octets, of the Origin field.</p>
<p>Origin: An OPTIONAL sequence of characters containing ASCII
   serialisation of an origin (<a href="https://tools.ietf.org/html/rfc6454">RFC6454</a>,
   Section 6.2) that the alternate service is applicable to.</p>
<p>Alt-Svc-Field-Value: A sequence of octets (length determined by
   subtracting the length of all preceding fields from the frame
   length) containing a value identical to the Alt-Svc field value
   defined in (Section 3)[<a href="https://tools.ietf.org/html/rfc7838#section-3">https://tools.ietf.org/html/rfc7838#section-3</a>]
   (ABNF production “Alt-Svc”).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
typeSpecificAttributes.ALTSVC = [<span class="hljs-string">'maxAge'</span>, <span class="hljs-string">'port'</span>, <span class="hljs-string">'protocolID'</span>, <span class="hljs-string">'host'</span>,
                                 <span class="hljs-string">'origin'</span>];

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">istchar</span>(<span class="hljs-params">c</span>) </span>{
  <span class="hljs-keyword">return</span> (<span class="hljs-string">'!#$&amp;\'*+-.^_`|~1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'</span>.indexOf(c) &gt; -<span class="hljs-number">1</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hexencode</span>(<span class="hljs-params">s</span>) </span>{
  <span class="hljs-keyword">var</span> t = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; s.length; i++) {
    <span class="hljs-keyword">if</span> (!istchar(s[i])) {
      t += <span class="hljs-string">'%'</span>;
      t += <span class="hljs-keyword">new</span> Buffer(s[i]).toString(<span class="hljs-string">'hex'</span>);
    } <span class="hljs-keyword">else</span> {
      t += s[i];
    }
  }
  <span class="hljs-keyword">return</span> t;
}

Serializer.ALTSVC = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeAltSvc</span>(<span class="hljs-params">frame, buffers</span>) </span>{
  <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">2</span>);
  buffer.writeUInt16BE(frame.origin.length, <span class="hljs-number">0</span>);
  buffers.push(buffer);
  buffers.push(<span class="hljs-keyword">new</span> Buffer(frame.origin, <span class="hljs-string">'ascii'</span>));

  <span class="hljs-keyword">var</span> fieldValue = hexencode(frame.protocolID) + <span class="hljs-string">'="'</span> + frame.host + <span class="hljs-string">':'</span> + frame.port + <span class="hljs-string">'"'</span>;
  <span class="hljs-keyword">if</span> (frame.maxAge !== <span class="hljs-number">86400</span>) { <span class="hljs-comment">// 86400 is the default</span>
    fieldValue += <span class="hljs-string">"; ma="</span> + frame.maxAge;
  }

  buffers.push(<span class="hljs-keyword">new</span> Buffer(fieldValue, <span class="hljs-string">'ascii'</span>));
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stripquotes</span>(<span class="hljs-params">s</span>) </span>{
  <span class="hljs-keyword">var</span> start = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> end = s.length;
  <span class="hljs-keyword">while</span> ((start &lt; end) &amp;&amp; (s[start] === <span class="hljs-string">'"'</span>)) {
    start++;
  }
  <span class="hljs-keyword">while</span> ((end &gt; start) &amp;&amp; (s[end - <span class="hljs-number">1</span>] === <span class="hljs-string">'"'</span>)) {
    end--;
  }
  <span class="hljs-keyword">if</span> (start &gt;= end) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
  }
  <span class="hljs-keyword">return</span> s.substring(start, end);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">splitNameValue</span>(<span class="hljs-params">nvpair</span>) </span>{
  <span class="hljs-keyword">var</span> eq = -<span class="hljs-number">1</span>;
  <span class="hljs-keyword">var</span> inQuotes = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; nvpair.length; i++) {
    <span class="hljs-keyword">if</span> (nvpair[i] === <span class="hljs-string">'"'</span>) {
      inQuotes = !inQuotes;
      <span class="hljs-keyword">continue</span>;
    }
    <span class="hljs-keyword">if</span> (inQuotes) {
      <span class="hljs-keyword">continue</span>;
    }
    <span class="hljs-keyword">if</span> (nvpair[i] === <span class="hljs-string">'='</span>) {
      eq = i;
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-keyword">if</span> (eq === -<span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> {<span class="hljs-string">'name'</span>: nvpair, <span class="hljs-string">'value'</span>: <span class="hljs-literal">null</span>};
  }

  <span class="hljs-keyword">var</span> name = stripquotes(nvpair.substring(<span class="hljs-number">0</span>, eq).trim());
  <span class="hljs-keyword">var</span> value = stripquotes(nvpair.substring(eq + <span class="hljs-number">1</span>).trim());
  <span class="hljs-keyword">return</span> {<span class="hljs-string">'name'</span>: name, <span class="hljs-string">'value'</span>: value};
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">splitHeaderParameters</span>(<span class="hljs-params">hv</span>) </span>{
  <span class="hljs-keyword">return</span> parseHeaderValue(hv, <span class="hljs-string">';'</span>, splitNameValue);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseHeaderValue</span>(<span class="hljs-params">hv, separator, callback</span>) </span>{
  <span class="hljs-keyword">var</span> start = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> inQuotes = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> values = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; hv.length; i++) {
    <span class="hljs-keyword">if</span> (hv[i] === <span class="hljs-string">'"'</span>) {
      inQuotes = !inQuotes;
      <span class="hljs-keyword">continue</span>;
    }
    <span class="hljs-keyword">if</span> (inQuotes) {</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Just skip this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">continue</span>;
    }
    <span class="hljs-keyword">if</span> (hv[i] === separator) {
      <span class="hljs-keyword">var</span> newValue = hv.substring(start, i).trim();
      <span class="hljs-keyword">if</span> (newValue.length &gt; <span class="hljs-number">0</span>) {
        newValue = callback(newValue);
        values.push(newValue);
      }
      start = i + <span class="hljs-number">1</span>;
    }
  }

  <span class="hljs-keyword">var</span> newValue = hv.substring(start).trim();
  <span class="hljs-keyword">if</span> (newValue.length &gt; <span class="hljs-number">0</span>) {
    newValue = callback(newValue);
    values.push(newValue);
  }

  <span class="hljs-keyword">return</span> values;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rsplit</span>(<span class="hljs-params">s, delim, count</span>) </span>{
  <span class="hljs-keyword">var</span> nsplits = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> end = s.length;
  <span class="hljs-keyword">var</span> rval = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = s.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
    <span class="hljs-keyword">if</span> (s[i] === delim) {
      <span class="hljs-keyword">var</span> t = s.substring(i + <span class="hljs-number">1</span>, end);
      end = i;
      rval.unshift(t);
      nsplits++;
      <span class="hljs-keyword">if</span> (nsplits === count) {
        <span class="hljs-keyword">break</span>;
      }
    }
  }
  <span class="hljs-keyword">if</span> (end !== <span class="hljs-number">0</span>) {
    rval.unshift(s.substring(<span class="hljs-number">0</span>, end));
  }
  <span class="hljs-keyword">return</span> rval;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ishex</span>(<span class="hljs-params">c</span>) </span>{
  <span class="hljs-keyword">return</span> (<span class="hljs-string">'0123456789ABCDEFabcdef'</span>.indexOf(c) &gt; -<span class="hljs-number">1</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unescape</span>(<span class="hljs-params">s</span>) </span>{
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> t = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">while</span> (i &lt; s.length) {
    <span class="hljs-keyword">if</span> (s[i] != <span class="hljs-string">'%'</span> || !ishex(s[i + <span class="hljs-number">1</span>]) || !ishex(s[i + <span class="hljs-number">2</span>])) {
      t += s[i];
    } <span class="hljs-keyword">else</span> {
      ++i;
      <span class="hljs-keyword">var</span> hexvalue = <span class="hljs-string">''</span>;
      <span class="hljs-keyword">if</span> (i &lt; s.length) {
        hexvalue += s[i];
        ++i;
      }
      <span class="hljs-keyword">if</span> (i &lt; s.length) {
        hexvalue += s[i];
      }
      <span class="hljs-keyword">if</span> (hexvalue.length &gt; <span class="hljs-number">0</span>) {
        t += <span class="hljs-keyword">new</span> Buffer(hexvalue, <span class="hljs-string">'hex'</span>).toString();
      } <span class="hljs-keyword">else</span> {
        t += <span class="hljs-string">'%'</span>;
      }
    }

    ++i;
  }
  <span class="hljs-keyword">return</span> t;
}

Deserializer.ALTSVC = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readAltSvc</span>(<span class="hljs-params">buffer, frame</span>) </span>{
  <span class="hljs-keyword">if</span> (buffer.length &lt; <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
  }
  <span class="hljs-keyword">var</span> originLength = buffer.readUInt16BE(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">if</span> ((buffer.length - <span class="hljs-number">2</span>) &lt; originLength) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'FRAME_SIZE_ERROR'</span>;
  }
  frame.origin = buffer.toString(<span class="hljs-string">'ascii'</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span> + originLength);
  <span class="hljs-keyword">var</span> fieldValue = buffer.toString(<span class="hljs-string">'ascii'</span>, <span class="hljs-number">2</span> + originLength);
  <span class="hljs-keyword">var</span> values = parseHeaderValue(fieldValue, <span class="hljs-string">','</span>, splitHeaderParameters);
  <span class="hljs-keyword">if</span> (values.length &gt; <span class="hljs-number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>TODO - warn that we only use one here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }
  <span class="hljs-keyword">if</span> (values.length === <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Well that’s a malformed frame. Just ignore it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">var</span> chosenAltSvc = values[<span class="hljs-number">0</span>];
  frame.maxAge = <span class="hljs-number">86400</span>; <span class="hljs-comment">// Default</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; chosenAltSvc.length; i++) {
    <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>This corresponds to the protocolID=”<host>:<port>“ item</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      frame.protocolID = <span class="hljs-built_in">unescape</span>(chosenAltSvc[i].name);
      <span class="hljs-keyword">var</span> hostport = rsplit(chosenAltSvc[i].value, <span class="hljs-string">':'</span>, <span class="hljs-number">1</span>);
      frame.host = hostport[<span class="hljs-number">0</span>];
      frame.port = <span class="hljs-built_in">parseInt</span>(hostport[<span class="hljs-number">1</span>], <span class="hljs-number">10</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (chosenAltSvc[i].name == <span class="hljs-string">'ma'</span>) {
      frame.maxAge = <span class="hljs-built_in">parseInt</span>(chosenAltSvc[i].value, <span class="hljs-number">10</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Otherwise, we just ignore this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <h2 id="blocked">BLOCKED</h2>

            </div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>The BLOCKED frame (type=0xB) indicates that the sender is unable to send data
due to a closed flow control window.</p>
<p>The BLOCKED frame does not define any flags and contains no payload.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
frameTypes[<span class="hljs-number">0xB</span>] = <span class="hljs-string">'BLOCKED'</span>;

frameFlags.BLOCKED = [];

typeSpecificAttributes.BLOCKED = [];

Serializer.BLOCKED = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeBlocked</span>(<span class="hljs-params">frame, buffers</span>) </span>{
};

Deserializer.BLOCKED = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readBlocked</span>(<span class="hljs-params">buffer, frame</span>) </span>{
};</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <h2 id="-error-codes-https-tools-ietf-org-html-rfc7540-section-7-"><a href="https://tools.ietf.org/html/rfc7540#section-7">Error Codes</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> errorCodes = [
  <span class="hljs-string">'NO_ERROR'</span>,
  <span class="hljs-string">'PROTOCOL_ERROR'</span>,
  <span class="hljs-string">'INTERNAL_ERROR'</span>,
  <span class="hljs-string">'FLOW_CONTROL_ERROR'</span>,
  <span class="hljs-string">'SETTINGS_TIMEOUT'</span>,
  <span class="hljs-string">'STREAM_CLOSED'</span>,
  <span class="hljs-string">'FRAME_SIZE_ERROR'</span>,
  <span class="hljs-string">'REFUSED_STREAM'</span>,
  <span class="hljs-string">'CANCEL'</span>,
  <span class="hljs-string">'COMPRESSION_ERROR'</span>,
  <span class="hljs-string">'CONNECT_ERROR'</span>,
  <span class="hljs-string">'ENHANCE_YOUR_CALM'</span>,
  <span class="hljs-string">'INADEQUATE_SECURITY'</span>,
  <span class="hljs-string">'HTTP_1_1_REQUIRED'</span>
];</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <h2 id="logging">Logging</h2>

            </div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p><a href="https://github.com/trentm/node-bunyan#serializers">Bunyan serializers</a> to improve logging output
for debug messages emitted in this component.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.serializers = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <ul>
<li><code>frame</code> serializer: it transforms data attributes from Buffers to hex strings and filters out
flags that are not present.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> frameCounter = <span class="hljs-number">0</span>;
exports.serializers.frame = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">frame</span>) </span>{
  <span class="hljs-keyword">if</span> (!frame) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-string">'id'</span> <span class="hljs-keyword">in</span> frame) {
    <span class="hljs-keyword">return</span> frame.id;
  }

  frame.id = frameCounter;
  frameCounter += <span class="hljs-number">1</span>;

  <span class="hljs-keyword">var</span> logEntry = { id: frame.id };
  genericAttributes.concat(typeSpecificAttributes[frame.type]).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
    logEntry[name] = frame[name];
  });

  <span class="hljs-keyword">if</span> (frame.data <span class="hljs-keyword">instanceof</span> Buffer) {
    <span class="hljs-keyword">if</span> (logEntry.data.length &gt; <span class="hljs-number">50</span>) {
      logEntry.data = frame.data.slice(<span class="hljs-number">0</span>, <span class="hljs-number">47</span>).toString(<span class="hljs-string">'hex'</span>) + <span class="hljs-string">'...'</span>;
    } <span class="hljs-keyword">else</span> {
      logEntry.data = frame.data.toString(<span class="hljs-string">'hex'</span>);
    }

    <span class="hljs-keyword">if</span> (!(<span class="hljs-string">'length'</span> <span class="hljs-keyword">in</span> logEntry)) {
      logEntry.length = frame.data.length;
    }
  }

  <span class="hljs-keyword">if</span> (frame.promised_stream <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Object</span>) {
    logEntry.promised_stream = <span class="hljs-string">'stream-'</span> + frame.promised_stream.id;
  }

  logEntry.flags = <span class="hljs-built_in">Object</span>.keys(frame.flags || {}).filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
    <span class="hljs-keyword">return</span> frame.flags[name] === <span class="hljs-literal">true</span>;
  });

  <span class="hljs-keyword">return</span> logEntry;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <ul>
<li><code>data</code> serializer: it simply transforms a buffer to a hex string.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.serializers.data = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
  <span class="hljs-keyword">return</span> data.toString(<span class="hljs-string">'hex'</span>);
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
