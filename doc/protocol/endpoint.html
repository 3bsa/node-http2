<!DOCTYPE html>

<html>
<head>
  <title>The Endpoint class</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              <a class="source" href="../index.html">API</a>
              
                
                <a class="source" href="compressor.html">
                  compressor.js
                </a>
              
                
                <a class="source" href="connection.html">
                  connection.js
                </a>
              
                
                <a class="source" href="endpoint.html">
                  endpoint.js
                </a>
              
                
                <a class="source" href="flow.html">
                  flow.js
                </a>
              
                
                <a class="source" href="framer.html">
                  framer.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="stream.html">
                  stream.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);

<span class="hljs-keyword">var</span> Serializer   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./framer'</span>).Serializer;
<span class="hljs-keyword">var</span> Deserializer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./framer'</span>).Deserializer;
<span class="hljs-keyword">var</span> Compressor   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./compressor'</span>).Compressor;
<span class="hljs-keyword">var</span> Decompressor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./compressor'</span>).Decompressor;
<span class="hljs-keyword">var</span> Connection   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./connection'</span>).Connection;
<span class="hljs-keyword">var</span> Duplex       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Duplex;
<span class="hljs-keyword">var</span> Transform    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Transform;

exports.Endpoint = Endpoint;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="the-endpoint-class">The Endpoint class</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="public-api">Public API</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <ul>
<li><p><strong>new Endpoint(log, role, settings, filters)</strong>: create a new Endpoint.</p>
<ul>
<li><code>log</code>: bunyan logger of the parent</li>
<li><code>role</code>: ‘CLIENT’ or ‘SERVER’</li>
<li><code>settings</code>: initial HTTP/2 settings</li>
<li><p><code>filters</code>: a map of functions that filter the traffic between components (for debugging or
intentional failure injection).</p>
<p>Filter functions get three arguments:</p>
<ol>
<li><code>frame</code>: the current frame</li>
<li><code>forward(frame)</code>: function that can be used to forward a frame to the next component</li>
<li><code>done()</code>: callback to signal the end of the filter process</li>
</ol>
<p>Valid filter names and their position in the stack:</p>
<ul>
<li><code>beforeSerialization</code>: after compression, before serialization</li>
<li><code>beforeCompression</code>: after multiplexing, before compression</li>
<li><code>afterDeserialization</code>: after deserialization, before decompression</li>
<li><code>afterDecompression</code>: after decompression, before multiplexing</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Event: ‘stream’ (Stream)</strong>: ‘stream’ event forwarded from the underlying Connection</p>
</li>
<li><p><strong>Event: ‘error’ (type)</strong>: signals an error</p>
</li>
<li><p><strong>createStream(): Stream</strong>: initiate a new stream (forwarded to the underlying Connection)</p>
</li>
<li><p><strong>close([error])</strong>: close the connection with an error code</p>
</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="constructor">Constructor</h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>The process of initialization:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Endpoint</span>(<span class="hljs-params">log, role, settings, filters</span>) </span>{
  Duplex.call(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <ul>
<li>Initializing logging infrastructure</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._log = log.child({ component: <span class="hljs-string">'endpoint'</span>, e: <span class="hljs-keyword">this</span> });</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <ul>
<li>First part of the handshake process: sending and receiving the client connection header
prelude.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  assert((role === <span class="hljs-string">'CLIENT'</span>) || role === <span class="hljs-string">'SERVER'</span>);
  <span class="hljs-keyword">if</span> (role === <span class="hljs-string">'CLIENT'</span>) {
    <span class="hljs-keyword">this</span>._writePrelude();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>._readPrelude();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <ul>
<li>Initialization of component. This includes the second part of the handshake process:
sending the first SETTINGS frame. This is done by the connection class right after
initialization.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._initializeDataFlow(role, settings, filters || {});</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <ul>
<li>Initialization of management code.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._initializeManagement();</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <ul>
<li>Initializing error handling.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._initializeErrorHandling();
}
Endpoint.prototype = <span class="hljs-built_in">Object</span>.create(Duplex.prototype, { constructor: { value: Endpoint } });</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h2 id="handshake">Handshake</h2>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> CLIENT_PRELUDE = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-string">'PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Writing the client header is simple and synchronous.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Endpoint.prototype._writePrelude = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_writePrelude</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>._log.debug(<span class="hljs-string">'Sending the client connection header prelude.'</span>);
  <span class="hljs-keyword">this</span>.push(CLIENT_PRELUDE);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>The asynchronous process of reading the client header:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Endpoint.prototype._readPrelude = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_readPrelude</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <ul>
<li>progress in the header is tracker using a <code>cursor</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> cursor = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <ul>
<li><code>_write</code> is temporarily replaced by the comparator function</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._write = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_temporalWrite</span>(<span class="hljs-params">chunk, encoding, done</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <ul>
<li>which compares the stored header with the current <code>chunk</code> byte by byte and emits the
‘error’ event if there’s a byte that doesn’t match</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> offset = cursor;
    <span class="hljs-keyword">while</span>(cursor &lt; CLIENT_PRELUDE.length &amp;&amp; (cursor - offset) &lt; chunk.length) {
      <span class="hljs-keyword">if</span> (CLIENT_PRELUDE[cursor] !== chunk[cursor - offset]) {
        <span class="hljs-keyword">this</span>._log.fatal({ cursor: cursor, offset: offset, chunk: chunk },
                        <span class="hljs-string">'Client connection header prelude does not match.'</span>);
        <span class="hljs-keyword">this</span>._error(<span class="hljs-string">'handshake'</span>, <span class="hljs-string">'PROTOCOL_ERROR'</span>);
        <span class="hljs-keyword">return</span>;
      }
      cursor += <span class="hljs-number">1</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <ul>
<li>if the whole header is over, and there were no error then restore the original <code>_write</code>
and call it with the remaining part of the current chunk</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (cursor === CLIENT_PRELUDE.length) {
      <span class="hljs-keyword">this</span>._log.debug(<span class="hljs-string">'Successfully received the client connection header prelude.'</span>);
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._write;
      chunk = chunk.slice(cursor - offset);
      <span class="hljs-keyword">this</span>._write(chunk, encoding, done);
    }
  };
};</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h2 id="data-flow">Data flow</h2>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <pre><code>+---------------------------------------------+
|                                             |
|   +-------------------------------------+   |
|   | +---------+ +---------+ +---------+ |   |
|   | | stream1 | | stream2 | |   ...   | |   |
|   | +---------+ +---------+ +---------+ |   |
|   |             connection              |   |
|   +-------------------------------------+   |
|             |                 ^             |
|        pipe |                 | pipe        |
|             v                 |             |
|   +------------------+------------------+   |
|   |    compressor    |   decompressor   |   |
|   +------------------+------------------+   |
|             |                 ^             |
|        pipe |                 | pipe        |
|             v                 |             |
|   +------------------+------------------+   |
|   |    serializer    |   deserializer   |   |
|   +------------------+------------------+   |
|             |                 ^             |
|     _read() |                 | _write()    |
|             v                 |             |
|      +------------+     +-----------+       |
|      |output queue|     |input queue|       |
+------+------------+-----+-----------+-------+
              |                 ^
       read() |                 | write()
              v                 |
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createTransformStream</span>(<span class="hljs-params">filter</span>) </span>{
  <span class="hljs-keyword">var</span> transform = <span class="hljs-keyword">new</span> Transform({ objectMode: <span class="hljs-literal">true</span> });
  <span class="hljs-keyword">var</span> push = transform.push.bind(transform);
  transform._transform = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">frame, encoding, done</span>) </span>{
    filter(frame, push, done);
  };
  <span class="hljs-keyword">return</span> transform;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pipeAndFilter</span>(<span class="hljs-params">stream1, stream2, filter</span>) </span>{
  <span class="hljs-keyword">if</span> (filter) {
    stream1.pipe(createTransformStream(filter)).pipe(stream2);
  } <span class="hljs-keyword">else</span> {
    stream1.pipe(stream2);
  }
}

Endpoint.prototype._initializeDataFlow = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initializeDataFlow</span>(<span class="hljs-params">role, settings, filters</span>) </span>{
  <span class="hljs-keyword">var</span> firstStreamId, compressorRole, decompressorRole;
  <span class="hljs-keyword">if</span> (role === <span class="hljs-string">'CLIENT'</span>) {
    firstStreamId = <span class="hljs-number">1</span>;
    compressorRole = <span class="hljs-string">'REQUEST'</span>;
    decompressorRole = <span class="hljs-string">'RESPONSE'</span>;
  } <span class="hljs-keyword">else</span> {
    firstStreamId = <span class="hljs-number">2</span>;
    compressorRole = <span class="hljs-string">'RESPONSE'</span>;
    decompressorRole = <span class="hljs-string">'REQUEST'</span>;
  }

  <span class="hljs-keyword">this</span>._serializer   = <span class="hljs-keyword">new</span> Serializer(<span class="hljs-keyword">this</span>._log);
  <span class="hljs-keyword">this</span>._deserializer = <span class="hljs-keyword">new</span> Deserializer(<span class="hljs-keyword">this</span>._log);
  <span class="hljs-keyword">this</span>._compressor   = <span class="hljs-keyword">new</span> Compressor(<span class="hljs-keyword">this</span>._log, compressorRole);
  <span class="hljs-keyword">this</span>._decompressor = <span class="hljs-keyword">new</span> Decompressor(<span class="hljs-keyword">this</span>._log, decompressorRole);
  <span class="hljs-keyword">this</span>._connection   = <span class="hljs-keyword">new</span> Connection(<span class="hljs-keyword">this</span>._log, firstStreamId, settings);

  pipeAndFilter(<span class="hljs-keyword">this</span>._connection, <span class="hljs-keyword">this</span>._compressor, filters.beforeCompression);
  pipeAndFilter(<span class="hljs-keyword">this</span>._compressor, <span class="hljs-keyword">this</span>._serializer, filters.beforeSerialization);
  pipeAndFilter(<span class="hljs-keyword">this</span>._deserializer, <span class="hljs-keyword">this</span>._decompressor, filters.afterDeserialization);
  pipeAndFilter(<span class="hljs-keyword">this</span>._decompressor, <span class="hljs-keyword">this</span>._connection, filters.afterDecompression);

  <span class="hljs-keyword">this</span>._connection.on(<span class="hljs-string">'ACKNOWLEDGED_SETTINGS_HEADER_TABLE_SIZE'</span>,
                      <span class="hljs-keyword">this</span>._decompressor.setTableSizeLimit.bind(<span class="hljs-keyword">this</span>._decompressor));
  <span class="hljs-keyword">this</span>._connection.on(<span class="hljs-string">'RECEIVING_SETTINGS_HEADER_TABLE_SIZE'</span>,
                      <span class="hljs-keyword">this</span>._compressor.setTableSizeLimit.bind(<span class="hljs-keyword">this</span>._compressor));
};

<span class="hljs-keyword">var</span> noread = {};
Endpoint.prototype._read = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_read</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>._readableState.sync = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> moreNeeded = noread, chunk;
  <span class="hljs-keyword">while</span> (moreNeeded &amp;&amp; (chunk = <span class="hljs-keyword">this</span>._serializer.read())) {
    moreNeeded = <span class="hljs-keyword">this</span>.push(chunk);
  }
  <span class="hljs-keyword">if</span> (moreNeeded === noread) {
    <span class="hljs-keyword">this</span>._serializer.once(<span class="hljs-string">'readable'</span>, <span class="hljs-keyword">this</span>._read.bind(<span class="hljs-keyword">this</span>));
  }
  <span class="hljs-keyword">this</span>._readableState.sync = <span class="hljs-literal">false</span>;
};

Endpoint.prototype._write = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_write</span>(<span class="hljs-params">chunk, encoding, done</span>) </span>{
  <span class="hljs-keyword">this</span>._deserializer.write(chunk, encoding, done);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="management">Management</h2>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
Endpoint.prototype._initializeManagement = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initializeManagement</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>._connection.on(<span class="hljs-string">'stream'</span>, <span class="hljs-keyword">this</span>.emit.bind(<span class="hljs-keyword">this</span>, <span class="hljs-string">'stream'</span>));
};

Endpoint.prototype.createStream = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createStream</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._connection.createStream();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2 id="error-handling">Error handling</h2>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
Endpoint.prototype._initializeErrorHandling = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initializeErrorHandling</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>._serializer.on(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">this</span>._error.bind(<span class="hljs-keyword">this</span>, <span class="hljs-string">'serializer'</span>));
  <span class="hljs-keyword">this</span>._deserializer.on(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">this</span>._error.bind(<span class="hljs-keyword">this</span>, <span class="hljs-string">'deserializer'</span>));
  <span class="hljs-keyword">this</span>._compressor.on(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">this</span>._error.bind(<span class="hljs-keyword">this</span>, <span class="hljs-string">'compressor'</span>));
  <span class="hljs-keyword">this</span>._decompressor.on(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">this</span>._error.bind(<span class="hljs-keyword">this</span>, <span class="hljs-string">'decompressor'</span>));
  <span class="hljs-keyword">this</span>._connection.on(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">this</span>._error.bind(<span class="hljs-keyword">this</span>, <span class="hljs-string">'connection'</span>));

  <span class="hljs-keyword">this</span>._connection.on(<span class="hljs-string">'peerError'</span>, <span class="hljs-keyword">this</span>.emit.bind(<span class="hljs-keyword">this</span>, <span class="hljs-string">'peerError'</span>));
};

Endpoint.prototype._error = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_error</span>(<span class="hljs-params">component, error</span>) </span>{
  <span class="hljs-keyword">this</span>._log.fatal({ source: component, message: error }, <span class="hljs-string">'Fatal error, closing connection'</span>);
  <span class="hljs-keyword">this</span>.close(error);
  setImmediate(<span class="hljs-keyword">this</span>.emit.bind(<span class="hljs-keyword">this</span>, <span class="hljs-string">'error'</span>, error));
};

Endpoint.prototype.close = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close</span>(<span class="hljs-params">error</span>) </span>{
  <span class="hljs-keyword">this</span>._connection.close(error);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h2 id="bunyan-serializers">Bunyan serializers</h2>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
exports.serializers = {};

<span class="hljs-keyword">var</span> nextId = <span class="hljs-number">0</span>;
exports.serializers.e = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">endpoint</span>) </span>{
  <span class="hljs-keyword">if</span> (!(<span class="hljs-string">'id'</span> <span class="hljs-keyword">in</span> endpoint)) {
    endpoint.id = nextId;
    nextId += <span class="hljs-number">1</span>;
  }
  <span class="hljs-keyword">return</span> endpoint.id;
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
